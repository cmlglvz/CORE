---
title: "CORE_Analisis"
output: html_document
---

## Libraries
```{r echo=TRUE, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(leaflet)
library(data.table)
library(grDevices)
library(BiodiversityR)
library(vegan)
library(treemap)
library(d3treeR)
library(htmlwidgets)
library(ComplexHeatmap)
library(circlize)
library(UpSetR)
library(RColorBrewer)
library(viridis)
library(ggsci)
library(ggvegan)
library(ggpubr)
library(plotly)
library(heatmaply)
```

##Map Sites PENDIENTE
```{r, echo=TRUE, message=TRUE, warning=TRUE}
stationsmap <- leaflet() %>% 
  addTiles() %>% 
  addProviderTiles("Stamen.TonerBackground") %>% 
  addCircleMarkers(lng = -70.667222, lat = -26.224278, color = "#F77F00", radius = 3, opacity = 1, label = "Cha") %>% 
  addCircleMarkers(lng = -70.7, lat = -26.548611, color = "#FCB740", radius = 3, opacity = 1, label = "Fla") %>% 
  addCircleMarkers(lng = -71.210278, lat = -28.336944, color = "#023E8A", radius = 3, opacity = 1, label = "Hu") %>% 
  addCircleMarkers(lng = -71.4975, lat = -29.223333, color = "#57E3FF", radius = 3, opacity = 1, label = "Hu") %>% 
  addCircleMarkers(lng = -6,5669, lat = 36,5533, color = "#AAECA1", radius = 3, opacity = 1, label = "TARA_004") %>% 
  addCircleMarkers(lng = 1,9378, lat = 37,051, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_007") %>% 
  addCircleMarkers(lng = 2,7996, lat = 41,6686, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_011") %>% 
  addCircleMarkers(lng = 17,4155, lat = 39,8386, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_022") %>% 
  addCircleMarkers(lng = 17,9348, lat = 42,4552, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_024") %>% 
  addCircleMarkers(lng = 19,3905, lat = 39,3888, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_025") %>% 
  addCircleMarkers(lng = 20,1705, lat = 38,4761, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_026") %>% 
  addCircleMarkers(lng = 32,898, lat = 33,9179, color = "#F1F500", radius = 3, opacity = 1, label = "TARA_030") %>% 
  addCircleMarkers(lng = 34,835, lat = 27,16, color = "#ACDD3C", radius = 3, opacity = 1, label = "TARA_031") %>% 
  addCircleMarkers(lng = 37,2183, lat = 23,36, color = "#ACDD3C", radius = 3, opacity = 1, label = "TARA_032") %>% 
  addCircleMarkers(lng = 39,8567, lat = 18,4417, color = "#ACDD3C", radius = 3, opacity = 1, label = "TARA_034") %>% 
  addCircleMarkers(lng = 63,5047, lat = 20,8183, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_036") %>% 
  addCircleMarkers(lng = 69,9776, lat = 14,6059, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_041") %>% 
  addCircleMarkers(lng = 73,8955, lat = 6,0001, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_042") %>% 
  addCircleMarkers(lng = 53,9801, lat = -16,957, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_052") %>% 
  addCircleMarkers(lng = 37,9889, lat = -29,5019, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_064") %>% 
  addCircleMarkers(lng = 26,2868, lat = -35,1728, color = "#6AAB30", radius = 3, opacity = 1, label = "TARA_065") %>% 
  addCircleMarkers(lng = 17,9189, lat = -34,9449, color = "#007F5F", radius = 3, opacity = 1, label = "TARA_066") %>% 
  addCircleMarkers(lng = 17,7103, lat = -32,2401, color = "#007F5F", radius = 3, opacity = 1, label = "TARA_067") %>% 
  addCircleMarkers(lng = -35,1803, lat = -20,9354, color = "#007F5F", radius = 3, opacity = 1, label = "TARA_076") %>% 
  addCircleMarkers(lng = -43,2899, lat = -30,1367, color = "#007F5F", radius = 3, opacity = 1, label = "TARA_078") %>% 
  addCircleMarkers(lng = -58,2902, lat = -47,1863, color = "#007F5F", radius = 3, opacity = 1, label = "TARA_082") %>% 
  addCircleMarkers(lng = -85,1545, lat = -5,2529, color = "#16DB93", radius = 3, opacity = 1, label = "TARA_102") %>% 
  addCircleMarkers(lng = -84,5766, lat = 1,9928, color = "#16DB93", radius = 3, opacity = 1, label = "TARA_109") %>% 
  addMeasure(position = "bottomright", primaryLengthUnit = "kilometers") %>% 
  addScaleBar(position = "bottomleft")
saveWidget(stationsmap, file = "X:/Documents/TARA/TARA/stationsmap.html")
```

## Dataframes
```{r, echo=TRUE, message=TRUE, warning=TRUE}
#DF with identified ASV by DADA2
CORE <- read.csv("X:/Documents/CORE/DADA2/seqtab_nonchim.csv", 
                 header = T, 
                 sep = ";", 
                 dec = '.', 
                 skip = 0, 
                 fill = TRUE, 
                 row.names = 1)
CORE <- apply(CORE, 2, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
samples <- c("C1A17", "C1F18", "C1A18", "C2A17", "C2F18", "C2A18", "C3A17", "C3F18", "C3A18", "C4A17", "C4F18", "C4A18", "F1A17", "F1F18", "F1A18", "F2A17", "F2F18", "F2A18", "F3A17", "F3F18", "F3A18", "F4A17", "F4F18", "F4A18", "H1A17", "H1F18", "H1A18", "H2A17", "H2F18", "H2A18", "H3A17", "H3F18", "H3A18", "H4A17", "H4F18", "H4A18", "P1F18", "P1A18", "P2F18", "P3F18", "P4F18", "Re1A17", "Re1F18", "L1A17", "L1F18", "L1A18", "L2A17", "L2F18", "L2A18", "L3A17", "L3F18", "L3A18", "L4A17", "L4F18", "L4A18", "Q1A17", "Q1F18", "Q2A17", "Q2F18", "Q3A17", "Q3F18", "Q3A18", "Q4A17", "Q4F18", "Q4A18", "Qc1A17", "Qc2A17", "Z1A18", "Z2A18", "Z3A18", "Z4A18", "Z5A18")
rownames(CORE) <- samples
write.csv2(CORE, file = "CORE_ASV.csv") #Saving some DF necessary for downstream analysis

#ASV assigned taxa from PR2 4.14 
taxa <- read.csv("X:/Documents/CORE/DADA2/taxa.csv", 
                 header = T, 
                 sep = ";", 
                 dec = '.', 
                 skip = 0) %>% 
  rename(Seq = X) %>% 
  add_column(OTU = c(paste0("ASV_", 1:11155)), .after = "Seq")
rownames(taxa) <- taxa[,1]
taxa2 <- filter(taxa, Kingdom == "Eukaryota" | Kingdom == "Eukaryota:nucl" | Kingdom == "Eukaryota:plas")
write.csv2(taxa, file = "CORE_taxa.csv")
write.csv2(taxa2, file = "euka_CORE.csv")
euk.CORE <- select(CORE, all_of(taxa2$Seq))
write.csv2(euk.CORE, "eukaryotes_core.csv")
print(all(colnames(CORE)%in%rownames(taxa))) #If TRUE you can continue
print(all(colnames(euk.CORE)%in%rownames(taxa2)))
```

#ASV identification
```{r, echo=TRUE, message=TRUE, warning=TRUE}
non.assigned <- taxa2[rowSums(is.na(taxa2[, c(3,4)])) > 0, ] #All ASV and Seq that have NA values at Kingdom and Supergroup levels
NAseq <- non.assigned[, 1]
na.taxa <- taxa2[!(row.names(taxa2) %in% all_of(NAseq)), ]
write.csv2(na.taxa, file = "taxa_NA_edited.csv")
na.asv <- euk.CORE %>% select(-all_of(NAseq))
write.csv2(na.asv, file = "ASV_NA_edited.csv")
```

## Rarefaction
Rarefaction is a technique to assess expected species richness. It allows the calculation of species richness for a given number of individual samples, based on the construction of rarefaction curves. The issue that occurs when sampling various species in a community is that the larger the number of individuals sampled, the more species that will be found. Rarefaction curves are created by randomly re-sampling the pool of N samples multiple times and then plotting the average number of species found in each sample (1,2, … N). “Thus rarefaction generates the expected number of species in a small collection of n individuals (or n samples) drawn at random from the large pool of N samples.”. Rarefaction curves generally grow rapidly at first, as the most common species are found, but the curves plateau as only the rarest species remain to be sampled.

```{r, echo=TRUE, message=TRUE, warning=TRUE}
rare.full <- sort(rowSums(CORE))
rare.full
plot(rare.full)

rrfy<- rarefy(CORE, rare.full[1]) #rarefaction uses the smallest number of observations per sample to extrapolate the expected number if all other samples only had that number of observations
rrfy #gives an "expected"rarefied" number of species (not obs) if only 41641 individuals were present per sample

kols <- colorRampPalette(c("#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F94144", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F3722C", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F8961E", "#F9C74F", "#F9C74F", "#F9C74F", "#F9C74F", "#F9C74F", "#90BE6D", "#90BE6D", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#43AA8B", "#577590", "#577590", "#577590", "#577590", "#577590", "#577590", "#577590", "#577590", "#577590", "#577590", "#41576C", "#41576C", "#4D908E", "#4D908E", "#4D908E", "#4D908E", "#4D908E"))(72)

tiff("Rarecurve_CORE.tiff", width = 12, height = 6, units = 'in', res = 300)
par(mar=c(5.1,4.1,4.1,2.1), oma=c(0,0,0,0))
rarecurve(x = CORE, col = kols, lwd = 2, las = 1, label = TRUE, step = 10, cex = 0.5)
dev.off()

rare.na <- sort(rowSums(na.asv))
rare.na
plot(rare.na)

na.rrfy<- rarefy(na.asv, rare.na[1])
na.rrfy

tiff("Rarecurve_NA_filtered_CORE.tiff", width = 12, height = 7, units = "in", res = 600)
par(mar=c(5.1,4.1,4.1,2.1), oma=c(0,0,0,0))
rarecurve(x = na.asv, col = kols, lwd = 2, las = 1, label = TRUE, step = 10, cex = 0.5)
dev.off()

naCORE <- as.data.frame(rrarefy(na.asv, rare.na[1]))
write.csv2(naCORE, file = "rarefacted_NA_filtered_CORE.csv")
```

```{r, echo=TRUE, message=TRUE, warning=TRUE}
ppe.taxa <- filter(taxa2, Division == "Chlorophyta" | Division == "Ochrophyta" | Division == "Cryptophyta" | Division == "Haptophyta" | Division == "Cryptophyta:nucl" | Division == "Katablepharidophyta" | Division == "Rhodophyta" | Division == "Chlorophyta:plas")
ppe.asv <- select(na.asv, all_of(ppe.taxa$Seq))
print(all(colnames(ppe.asv)%in%rownames(ppe.taxa)))
write.csv2(ppe.taxa, "ppe_taxa.csv")
write.csv2(ppe.asv, "ppe_asv.csv")

eCORE <- as.data.frame(t(ppe.asv))
eCORE <- eCORE  %>% 
  mutate(Seq = all_of(rownames(eCORE)), .before = "C1A17")
eCORE <- eCORE %>%
  mutate(Cha = rowSums(eCORE[2:13]),
         Fla = rowSums(eCORE[14:25]), 
         Hu = rowSums(eCORE[26:37]), 
         Pc = rowSums(eCORE[38:42]), 
         Ho = rowSums(eCORE[43:44]), 
         LC = rowSums(eCORE[45:56]), 
         Qin = rowSums(eCORE[57:66]), 
         Qc = rowSums(eCORE[67:68]), 
         ZZ = rowSums(eCORE[69:73]), 
         Total = rowSums(eCORE[2:73])
         )
ATs <- inner_join(eCORE, ppe.taxa, by = "Seq") %>% relocate(OTU, .after = Seq)
rownames(ATs) <- all_of(ATs[,1])
write.csv2(ATs, file = "AT_CORE.csv")
#eATs <- ATs %>% select(Seq, Cha, Fla, Hu, Ho, Pc, Total, Division, Class, Order, Family, Genus, Species)
```

```{r, echo=TRUE, message=TRUE, warning=TRUE}
Tax.sum <- function(OTU.Table, Tax.Table, Tax.lvl ){
  z <- NULL
  y <- NULL
  for (i in 1:length(unique(Tax.Table[colnames(OTU.Table),Tax.lvl]))) {
    if (length(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])!=length(rownames(OTU.Table))) {
      z <- which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])
      y <- cbind(y, apply(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])], 1, function(x) sum(x)))
    } else { 
      y <- cbind(y, OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])
    }
  }
  colnames(y) <- unique(Tax.Table[colnames(OTU.Table),Tax.lvl])
  invisible((y))
}

Phylum <- Tax.sum(na.asv, na.taxa, 5) %>% as.data.frame()
ppe.phy <- Tax.sum(ppe.asv, ppe.taxa, 5) %>% as.data.frame()
ppe.phy <- ppe.phy[,c()]

write.csv2(Phylum, file = "phylum_CORE.csv")

ph.core <- read.csv("phylum_CORE.csv", 
                    header = TRUE, 
                    sep = ";", 
                    dec = ".", 
                    skip = 0, 
                    row.names = 1)
ph.core <- ph.core[,c(2,5,6,8,13,15,17,36)]
colnames(ph.core)[c(1,3,5,8)] <- c("A", "B", "C", "D")
ph.core <- ph.core %>% 
  mutate(Chlorophyta = rowSums(ph.core[c(1,8)]), 
         Cryptophyta = rowSums(ph.core[c(3,5)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(ph.core, file = "ppe_phylum_core.csv")

phyla <- as.data.frame(t(ph.core))
write.csv2(phyla, file = "phyla_core.csv")

phyla <- read.csv("phyla_core.csv", 
                  header = TRUE, 
                  sep = ";", 
                  dec = ".", 
                  skip = 0)
phyla <- phyla %>% 
  mutate(Cha = rowSums(phyla[2:13]),
         Fla = rowSums(phyla[14:25]), 
         Hu = rowSums(phyla[26:37]), 
         Pc = rowSums(phyla[38:42]), 
         Ho = rowSums(phyla[43:44]), 
         LC = rowSums(phyla[45:56]), 
         Qin = rowSums(phyla[57:66]), 
         Qc = rowSums(phyla[67:68]), 
         ZZ = rowSums(phyla[69:73]), 
         Total = rowSums(phyla[2:73])
         )
phyla <- arrange(phyla, desc(Total))
#phyla <- phyla %>% mutate(Color = c("#002C3D", "#00564E", "#007F5F", "#359548", "#6AAB30", "#BACC0C", "#F1F500", "#ACDD3C", "#83E377", "#16DB93", "#FB9C70", "#FB9262", "#FA8072", "#FA776B", "#F95C74", "#F8417D", "#AA006A", "#7C0068", "#4E0066", "#410151", "#C5DBEA", "#8BB7D4", "#5193BE", "#176EA8", "#00609F", "#023E8A", "#000078", "#161664", "#17315F", "#0B0B30", "#FF0000", "#CC0000", "#9B2226", "#4E1114", "#800000", "#000000"))
phycol <- phyla %>% 
  mutate(Color = c("#440154", "#1C3B74", "#20A387", "#95D840", "#F94144", "#FFBE17"))
write.csv2(phycol, file = "color_ppe_phyla_core.csv")

tiff("Contribution_Distribution_PPE_CORE_phylum_level.tiff", width = 17, height = 15, units = 'in', res = 600)
treemap(phycol, 
        index = "X", 
        vSize = "Total", 
        type = "color",
        vColor = "Color",
        position.legend = "none", 
        fontsize.labels = 20,
        fontsize.title = 30,
        title = "CORE labmicmar database",
        title.legend = NA,
        border.col = NA
)
dev.off()

tiff("Contribution_Distribution_PPE_CORE_phylum_level_legend.tiff", width = 10, height = 7, units = 'in', res = 600)
plot.new()
par(mar = c(0,0,0,0), oma = c(0,0,0,0))
legend("center", legend = phyla[, 1], cex = 1.2, ncol = 2, fill = phycol$Color, x.intersp = 0.3, xjust = 0.3, yjust = 0.5, y.intersp = 1, bty = "n", adj = 0, text.width = 0.3, pt.cex = 0.3)
dev.off()
```

```{r, echo=TRUE, message=TRUE, warning=TRUE}
rltv.Otu.Table <- function(x){
  x.Data.rltv <- NULL
  for (i in 1:dim(x)[1]) {
    x.Data.rltv <- rbind(x.Data.rltv, x[i,]/apply(x, 1, function(x) sum(x))[i])
  }
  rownames(x.Data.rltv) <- rownames(x)
  invisible(x.Data.rltv)
}

relative <- as.data.frame(t(ph.core))
relative <- relative[phyla$X, ] #mantener orden
relative <- as.data.frame(t(relative))
relative <- rltv.Otu.Table(relative)
apply(relative, 2, function(x) sum(x))[1:72]
write.csv2(relative, file = "relative_abundance_ppe_core_phylum_level.csv")
#rltvTSDiv <- rltvTSDiv[, -11]

tiff("Relative_Abundance_PPE_CORE_phylum_lvl.tiff", width = 20, height = 8, units = 'in', res = 600)
par(mar = c(5.1,4.1,4.1,2.1), oma = c(0,0,0,0))
barplot(t(relative), border = NA, ylab = "Relative Abundance", ylim = c(0,1), axes = TRUE, col = phycol$Color, las = 2, cex.names = 0.8, cex.axis = 0.9)
dev.off()

tiff("Relative_Abundance_PPE_CORE_phylum_lvl_legend.tiff", width = 10, height = 7, units = 'in', res = 600)
plot.new()
par(mar = c(0,0,0,0), oma = c(0,0,0,0))
legend("center", legend = colnames(relative), cex = 1.1, ncol = 2, fill = phycol$Color, x.intersp = 0.2, xjust = 0.2, yjust = 0.5, y.intersp = 1, bty = "n", adj = 0, text.width = 0.2, pt.cex = 0.2)
dev.off()
```

## Data preparation for UpSetR
```{r, echo=TRUE, message=TRUE, warning=TRUE}
otuAT <- ATs[, 2]
edATs <- ATs[, -c(2,84:92)]
rownames(edATs) <- otuAT
write.csv2(edATs, file = "edited_ats_core.csv")
print(all(all_of(edATs$Seq)%in%colnames(na.asv)))

APATs <- edATs[, -1]
APATs <- decostand(APATs, method = "pa")
APATs <- add_column(APATs, Seq = all_of(edATs$Seq), .before = "C1A17")
write.csv2(APATs, file = "auspres_core.csv")
```

```{r, echo=TRUE, message=TRUE, warning=TRUE}
ppe.at <- ATs %>% filter(Division == "Chlorophyta" | Division == "Chlorophyta:plas" | Division == "Ochrophyta" | Division == "Cryptophyta" | Division == "Cryptophyta:nucl" | Division == "Haptophyta" | Division == "Katablepharidophyta" | Division == "Rhodophyta")
otuPPE <- ppe.at[,2]
eppe.at <- ppe.at[, -c(2,84:92)]
rownames(eppe.at) <- otuPPE
write.csv2(eppe.at, file = "edited_ppe_ats_core.csv")

ppe.APATs <- eppe.at[, -1]
ppe.APATs <- decostand(ppe.APATs, method = "pa")
ppe.APATs <- add_column(ppe.APATs, Seq = all_of(eppe.at$Seq), .before = "C1A17")
write.csv2(ppe.APATs, file = "auspres_ppe_core.csv")
```

##UpSetR
```{r, echo=TRUE, message=TRUE, warning=TRUE}
aus.pres <- read.csv("auspres_core.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".", 
                     skip = 0)
tiff("UpSetR_EX.tiff", width = 27, height = 11, units = 'in', res = 600)
upset(aus.pres, 
      nsets = 9, 
      nintersects = NA,
      sets = c("Cha", "Fla", "Hu", "Pc", "Ho", "LC", "Qin", "Qc", "ZZ"), 
      keep.order = TRUE,
      query.legend = "top",
      queries = list(list(query = intersects, params = "Cha", color = "#F94144", active = TRUE, query.name = "Unique Chanaral ASV"), 
                     list(query = intersects, params = "Fla", color = "#F3722C", active = TRUE, query.name = "Unique Flamenco ASV"), 
                     list(query = intersects, params = "Hu", color = "#F8961E", active = TRUE, query.name = "Unique Huasco ASV"), 
                     list(query = intersects, params = "Pc", color = "#F9C74F", active = TRUE, query.name = "Unique Punta Choros ASV"),
                     list(query = intersects, params = "Ho", color = "#90BE6D", active = TRUE, query.name = "Unique Hornos ASV"),
                     list(query = intersects, params = "LC", color = "#43AA8B", active = TRUE, query.name = "Unique Las Cruces ASV"),
                     list(query = intersects, params = "Qin", color = "#577590", active = TRUE, query.name = "Unique Quintero ASV"),
                     list(query = intersects, params = "Qc", color = "#41576C", active = TRUE, query.name = "Unique Quintero-costa ASV"), 
                     list(query = intersects, params = "ZZ", color = "#4D908E", active = TRUE, query.name = "Unique ZZ ASV"), 
                     list(query = intersects, params = list("Cha", "Fla", "Hu", "Pc", "Ho", "LC", "Qin", "Qc", "ZZ"), color = "#FF0000", active = TRUE, query.name = "Shared ASV for all sites")
                     ), 
      point.size = 3, 
      line.size = 1.1, 
      text.scale = 1.6,
      mainbar.y.label = "Intersection Size", 
      sets.x.label = "Set Site")
dev.off()
```

```{r, echo=TRUE, message=TRUE, warning=TRUE}
ppe.aup <- read.csv("auspres_ppe_core.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".", 
                     skip = 0)
tiff("UpSetR_PPE_CORE.tiff", width = 20, height = 11, units = 'in', res = 600)
upset(ppe.aup, 
      nsets = 9, 
      nintersects = NA,
      sets = c("ZZ", "Qc", "Qin", "LC", "Ho", "Pc", "Hu", "Fla", "Cha"), 
      intersections = list("ZZ", "Qc", "Qin", "LC", "Ho", "Pc", "Hu", "Fla", "Cha", 
        list("Fla", "ZZ"), 
        list("Cha", "ZZ"), 
        list("Cha", "Fla"), 
        list("Qin", "LC"), 
        list("Hu", "LC"), 
        list("Hu", "ZZ"), 
        list("Cha", "Fla", "Hu", "ZZ"),
        list("Cha", "Fla", "Hu", "Pc"),
        list("Cha", "Fla", "Hu", "Pc", "LC", "Qin", "ZZ"),
        list("Cha", "Fla", "Hu", "Pc", "Ho", "LC", "Qin", "ZZ"), 
        list("Cha", "Fla", "Hu", "Pc", "Ho", "LC", "Qin", "Qc", "ZZ")
        ),
      empty.intersections = "on",
      keep.order = TRUE,
      query.legend = "top",
      queries = list(list(query = intersects, params = "Cha", color = "#F95C74", active = TRUE, query.name = "Unique Chanaral ASV"), 
                     list(query = intersects, params = "Fla", color = "#F72585", active = TRUE, query.name = "Unique Flamenco ASV"), 
                     list(query = intersects, params = "Hu", color = "#F72585", active = TRUE, query.name = "Unique Huasco ASV"), 
                     list(query = intersects, params = "Pc", color = "#7209B7", active = TRUE, query.name = "Unique Punta Choros ASV"),
                     list(query = intersects, params = "Ho", color = "#3A0CA3", active = TRUE, query.name = "Unique Hornos ASV"),
                     list(query = intersects, params = "LC", color = "#3F37C9", active = TRUE, query.name = "Unique Las Cruces ASV"),
                     list(query = intersects, params = "Qin", color = "#4361EE", active = TRUE, query.name = "Unique Quintero ASV"),
                     list(query = intersects, params = "Qc", color = "#4895EF", active = TRUE, query.name = "Unique Quintero costa ASV"), 
                     list(query = intersects, params = list("Cha", "Fla", "Hu", "Pc"), color = "#16DB93", active = TRUE, query.name = "Poluted Axis ASV"), 
                     list(query = intersects, params = list("Cha", "Fla", "Hu", "Pc", "Ho", "LC", "Qin", "Qc", "ZZ"), color = "#FF0000", active = TRUE, query.name = "Shared ASV")
                     ), 
      point.size = 3.2, 
      line.size = 1.5, 
      text.scale = 1.8,
      mainbar.y.label = "Site Intersections", 
      sets.x.label = "ASV per sampling site")
dev.off()
```

##Sequence identification
```{r Shared, echo=TRUE, message=TRUE, warning=TRUE}
ppe.asv <- select(naCORE, all_of(ppe.at$Seq))
Sha <- ppe.APATs
Sha <- Sha %>% filter(Cha == 1 & Fla == 1 & Hu == 1 & Pc == 1 & Ho == 1 & LC == 1 & Qin == 1 & Qc == 1 & ZZ == 1)
Shared <- select(ppe.asv, all_of(Sha$Seq))
sha.phy <- Tax.sum(Shared, taxa, 5) %>% as.data.frame() #De las 6 phyla de PPE solo 4 son compartidas por todos los sitios
difference <- Sha$Seq
diff.sha <- select(ppe.asv, -all_of(difference))
diff.phy <- Tax.sum(diff.sha, taxa, 5) %>% as.data.frame()
colnames(diff.phy)[c(2,3,7,8)] <- c("A", "B", "C", "D")
diff.phy <- diff.phy %>% 
  mutate(Chlorophyta = rowSums(diff.phy[c(2,8)]), 
         Cryptophyta = rowSums(diff.phy[c(3,7)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(diff.phy, file = "ppe_not_shared_phylum_abundance.csv")
```

```{r Cha, echo=TRUE, message=TRUE, warning=TRUE}
Cha <- ppe.APATs %>% filter(Cha == 1)
unique.cha <- Cha %>% filter(Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
cha.abun <- select(ppe.asv, all_of(Cha$Seq))
write.csv2(cha.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/chanaral_asv_table.csv")
ucha.abun <- select(ppe.asv, all_of(unique.cha$Seq))
write.csv2(ucha.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_chanaral_asv_table")
cha.phy <- Tax.sum(cha.abun, taxa, 5) %>% as.data.frame()
colnames(cha.phy)[c(1,3,6,8)] <- c("A", "B", "C", "D")
cha.phy <- cha.phy %>% 
  mutate(Chlorophyta = rowSums(cha.phy[c(1,8)]), 
         Cryptophyta = rowSums(cha.abun[c(3,6)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(cha.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_chanaral_phyla_abundance.csv")
ucha.phy <- Tax.sum(ucha.abun, taxa, 5) %>% as.data.frame()
colnames(ucha.phy)[c(3,5)] <- c("A", "B")
ucha.phy <- ucha.phy %>% 
  mutate(Chlorophyta = rowSums(ucha.phy[c(3,5)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(ucha.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_chanaral_phyla_abundance.csv")
```

```{r Fla, echo=TRUE, message=TRUE, warning=TRUE}
Fla <- ppe.APATs %>% filter(Fla == 1)
unique.fla <- Fla %>% filter(Cha == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
fla.abun <- select(ppe.asv, all_of(Fla$Seq))
write.csv2(cha.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/flamenco_asv_table.csv")
ufla.abun <- select(ppe.asv, all_of(unique.fla$Seq))
write.csv2(ufla.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_flamenco_asv_table")
fla.phy <- Tax.sum(fla.abun, taxa, 5) %>% as.data.frame()
colnames(fla.phy)[c(1,3,6,8)] <- c("A", "B", "C", "D")
fla.phy <- fla.phy %>% 
  mutate(Chlorophyta = rowSums(fla.phy[c(1,8)]), 
         Cryptophyta = rowSums(fla.abun[c(3,6)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(fla.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_flamenco_phyla_abundance.csv")
ufla.phy <- Tax.sum(ufla.abun, taxa, 5) %>% as.data.frame()
ufla.phy <- ufla.phy[, c(3,2,5,1,6,4)]
write.csv2(ufla.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_flamenco_phyla_abundance.csv")
```

```{r Hu, echo=TRUE, message=TRUE, warning=TRUE}
Hu <- ppe.APATs %>% filter(Hu == 1)
unique.hu <- Hu %>% filter(Cha == 0 & Fla == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
hu.abun <- select(ppe.asv, all_of(Hu$Seq))
write.csv2(hu.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/huasco_asv_table.csv")
uhu.abun <- select(ppe.asv, all_of(unique.hu$Seq))
write.csv2(uhu.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_huasco_asv_table.csv")
hu.phy <- Tax.sum(hu.abun, taxa, 5) %>% as.data.frame()
colnames(hu.phy)[c(1,7)] <- c("A", "B")
hu.phy <- hu.phy %>% 
  mutate(Chlorophyta = rowSums(hu.phy[c(1,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(hu.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_huasco_phyla_abundance.csv")
uhu.phy <- Tax.sum(uhu.abun, taxa, 5) %>% as.data.frame()
uhu.phy <- uhu.phy[, c(1,2,5,3,6,4)]
write.csv2(uhu.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_huasco_phyla_abundance.csv")
```

```{r Pc, echo=TRUE, message=TRUE, warning=TRUE}
Pc <- ppe.APATs %>% filter(Pc == 1)
unique.pc <- Pc %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
pc.abun <- select(ppe.asv, all_of(Pc$Seq))
write.csv2(pc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/puntachoros_asv_table.csv")
upc.abun <- select(ppe.asv, all_of(unique.pc$Seq))
write.csv2(upc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_puntachoros_asv_table.csv")
pc.phy <- Tax.sum(pc.abun, taxa, 5) %>% as.data.frame()
colnames(pc.phy)[c(1,2,7,8)] <- c("A", "B", "C", "D")
pc.phy <- pc.phy %>% 
  mutate(Chlorophyta = rowSums(pc.phy[c(1,8)]), 
         Cryptophyta = rowSums(pc.phy[c(2,7)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(pc.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_puntachoros_phyla_abundance.csv")
upc.phy <- Tax.sum(upc.abun, taxa, 5) %>% as.data.frame()
colnames(upc.phy)[c(4,7)] <- c("A", "B")
upc.phy <- upc.phy %>% 
  mutate(Chlorophyta = rowSums(upc.phy[c(4,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(upc.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_puntachoros_phyla_abundance.csv")
```

```{r Ho, echo=TRUE, message=TRUE, warning=TRUE}
Ho <- ppe.APATs %>% filter(Ho == 1)
unique.ho <- Ho %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & LC == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
ho.abun <- select(ppe.asv, all_of(Ho$Seq))
write.csv2(ho.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/hornos_asv_table.csv")
uho.abun <- select(ppe.asv, all_of(unique.ho$Seq))
write.csv2(uho.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_hornos_asv_table.csv")
ho.phy <- Tax.sum(ho.abun, taxa, 5) %>% as.data.frame()
colnames(ho.phy)[c(2,7)] <- c("A", "B")
ho.phy <- ho.phy %>% 
  mutate(Cryptophyta = rowSums(ho.phy[c(2,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(ho.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_hornos_phyla_abundance.csv")
uho.phy <- Tax.sum(uho.abun, taxa, 5) %>% as.data.frame()
uho.phy <- uho.phy[, c(2,1,4,5,3)]
write.csv2(uho.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_hornos_phyla_abundance.csv")
```

```{r LC, echo=TRUE, message=TRUE, warning=TRUE}
LC <- ppe.APATs %>% filter(LC == 1)
unique.lc <- LC %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & Qin == 0 & Qc == 0 & ZZ == 0)
lc.abun <- select(ppe.asv, all_of(LC$Seq))
write.csv2(lc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/lascruces_asv_table.csv")
ulc.abun <- select(ppe.asv, all_of(unique.lc$Seq))
write.csv2(ulc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_lascruces_asv_table.csv")
lc.phy <- Tax.sum(lc.abun, taxa, 5) %>% as.data.frame()
colnames(lc.phy)[c(1,3,7,8)] <- c("A", "B", "C", "D")
lc.phy <- lc.phy %>% 
  mutate(Cryptophyta = rowSums(lc.phy[c(3,7)]), 
         Chlorophyta = rowSums(lc.phy[c(1,8)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(lc.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_lascruces_phyla_abundance.csv")
ulc.phy <- Tax.sum(ulc.abun, taxa, 5) %>% as.data.frame()
colnames(ulc.phy)[c(3,5,6,8)] <- c("A", "B", "C", "D")
ulc.phy <- ulc.phy %>% 
  mutate(Chlorophyta = rowSums(ulc.phy[c(3,8)]), 
         Cryptophyta = rowSums(ulc.phy[c(5,6)])
         ) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(ulc.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_lascruces_phyla_abundance.csv")
```

```{r Qin, echo=TRUE, message=TRUE, warning=TRUE}
Qin <- ppe.APATs %>% filter(Qin == 1)
unique.qin <- Qin %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qc == 0 & ZZ == 0)
qin.abun <- select(ppe.asv, all_of(Qin$Seq))
write.csv2(qin.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/quintero_asv_table.csv")
uqin.abun <- select(ppe.asv, all_of(unique.qin$Seq))
write.csv2(uqin.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_quintero_asv_table.csv")
qin.phy <- Tax.sum(qin.abun, taxa, 5) %>% as.data.frame()
colnames(qin.phy)[c(3,7)] <- c("A", "B")
qin.phy <- qin.phy %>% 
  mutate(Cryptophyta = rowSums(qin.phy[c(3,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(qin.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_quintero_phyla_abundance.csv")
uqin.phy <- Tax.sum(uqin.abun, taxa, 5) %>% as.data.frame()
uqin.phy <- uqin.phy[, c(2,1,6,3,5,4)]
write.csv2(uqin.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_qintero_phyla_abundance.csv")
```

```{r Qc, echo=TRUE, message=TRUE, warning=TRUE}
Qc <- ppe.APATs %>% filter(Qc == 1)
unique.qc <- Qc %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & ZZ == 0)
qc.abun <- select(ppe.asv, all_of(Qc$Seq))
write.csv2(qc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/quinterocosta_asv_table.csv")
uqc.abun <- select(ppe.asv, all_of(unique.qc$Seq))
write.csv2(uqc.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_quinterocosta_asv_table.csv")
qc.phy <- qc.abun[c(68,69),]
qc.phy <- Tax.sum(qc.phy, taxa, 5) %>% as.data.frame()
qc.phy <- qc.phy[,c(1,2,3,6,5,4)]
write.csv2(qin.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_quinterocosta_phyla_abundance.csv")
uqc.phy <- Tax.sum(uqc.abun, taxa, 5) %>% as.data.frame()
uqc.phy <- uqc.phy[, c(3,2,1)]
write.csv2(uqc.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/unique_ppe_qinterocosta_phyla_abundance.csv")
```

```{r ZZ, echo=TRUE, message=TRUE, warning=TRUE}
ZZ <- ppe.APATs %>% filter(ZZ == 1)
#esto debiese dar 0
unique.zz <- ZZ %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0)
zz.abun <- select(ppe.asv, all_of(ZZ$Seq))
write.csv2(zz.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/zz_asv_table.csv")
zz.phy <- Tax.sum(zz.abun, taxa, 5) %>% as.data.frame()
colnames(zz.phy)[c(1,7)] <- c("A", "B")
zz.phy <- zz.phy %>% 
  mutate(Chlorophyta = rowSums(zz.phy[c(1,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(zz.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_zz_phyla_abundance.csv")
```

```{r ZZ, echo=TRUE, message=TRUE, warning=TRUE}
ZZ <- ppe.APATs %>% filter(ZZ == 1)
#esto debiese dar 0
unique.zz <- ZZ %>% filter(Cha == 0 & Fla == 0 & Hu == 0 & Pc == 0 & Ho == 0 & LC == 0 & Qin == 0 & Qc == 0)
zz.abun <- select(ppe.asv, all_of(ZZ$Seq))
write.csv2(zz.abun, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/zz_asv_table.csv")
zz.phy <- Tax.sum(zz.abun, taxa, 5) %>% as.data.frame()
colnames(zz.phy)[c(1,7)] <- c("A", "B")
zz.phy <- zz.phy %>% 
  mutate(Chlorophyta = rowSums(zz.phy[c(1,7)])) %>% 
  select(Chlorophyta, Ochrophyta, Cryptophyta, Haptophyta, Katablepharidophyta, Rhodophyta)
write.csv2(zz.phy, file = "/Users/Artemis/Documents/GitHub/CORE/Analisis/ppe_zz_phyla_abundance.csv")
```
