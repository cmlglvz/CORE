---
title: "Core_Microbiota"
author: "Camilo GÃ¡lvez A."
output: html_document
---

#Libraries
```{r libraries, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(data.table)
library(Biostrings)
library(DECIPHER)
library(vegan)
library(UpSetR)
library(leaflet)
library(treemap)
library(viridis)
library(heatmaply)
library(htmlwidgets)
library(hrbrthemes)
library(metacoder)
```

#Interactive map
```{r interactive map, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
stationsmap <- leaflet() %>% 
  addTiles() %>% 
  setView(lng = -23.86725804882807, lat = 12.726777153022745, zoom = 2.5) %>% 
  addProviderTiles("Stamen.TonerBackground") %>% 
  addCircleMarkers(lng = -70.667222, lat = -26.224278, color = "#FF8811", radius = 3.5, opacity = 1, label = "Chanaral") %>% 
  addCircleMarkers(lng = -70.7, lat = -26.548611, color = "#F4D06F", radius = 3.5, opacity = 1, label = "Flamenco") %>% 
  addCircleMarkers(lng = -71.210278, lat = -28.336944, color = "#392F5A", radius = 3.5, opacity = 1, label = "Huasco") %>% 
  addCircleMarkers(lng = -71.4975, lat = -29.223333, color = "#403286", radius = 3.5, opacity = 1, label = "Punta de Choros") %>% 
  addCircleMarkers(lng = -71.519083, lat = -32.7555, color = "#18E0BD", radius = 3.5, opacity = 1, label = "Quintero") %>% 
  addCircleMarkers(lng = -71.624688, lat = -33.500600, color = "#80EB9F", radius = 3.5, opacity = 1, label = "Las Cruces") %>% 
  addCircleMarkers(lng = -6.5669, lat = 36.5533, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_004") %>% 
  addCircleMarkers(lng = 1.9378, lat = 37.051, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_007") %>% 
  addCircleMarkers(lng = 2.7996, lat = 41.6686, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_011") %>% 
  addCircleMarkers(lng = 17.4155, lat = 39.8386, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_022") %>% 
  addCircleMarkers(lng = 17.9348, lat = 42.4552, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_024") %>% 
  addCircleMarkers(lng = 19.3905, lat = 39.3888, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_025") %>% 
  addCircleMarkers(lng = 20.1705, lat = 38.4761, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_026") %>% 
  addCircleMarkers(lng = 32.898, lat = 33.9179, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_030") %>% 
  addCircleMarkers(lng = 34.835, lat = 27.16, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_031") %>% 
  addCircleMarkers(lng = 37.2183, lat = 23.36, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_032") %>% 
  addCircleMarkers(lng = 39.8567, lat = 18.4417, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_034") %>% 
  addCircleMarkers(lng = 63.5047, lat = 20.8183, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_036") %>% 
  addCircleMarkers(lng = 69.9776, lat = 14.6059, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_041") %>% 
  addCircleMarkers(lng = 73.8955, lat = 6.0001, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_042") %>% 
  addCircleMarkers(lng = 53.9801, lat = -16.957, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_052") %>% 
  addCircleMarkers(lng = 37.9889, lat = -29.5019, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_064") %>% 
  addCircleMarkers(lng = 26.2868, lat = -35.1728, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_065") %>% 
  addCircleMarkers(lng = 17.9189, lat = -34.9449, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_066") %>% 
  addCircleMarkers(lng = 17.7103, lat = -32.2401, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_067") %>% 
  addCircleMarkers(lng = -35.1803, lat = -20.9354, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_076") %>% 
  addCircleMarkers(lng = -43.2899, lat = -30.1367, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_078") %>% 
  addCircleMarkers(lng = -58.2902, lat = -47.1863, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_082") %>% 
  addCircleMarkers(lng = -85.1545, lat = -5.2529, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_102") %>% 
  addCircleMarkers(lng = -84.5766, lat = 1.9928, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_109") %>% 
  addCircleMarkers(lng = -3.9375, lat = 48.7778, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_002") %>% 
  addCircleMarkers(lng = 7.9, lat = 54.18194, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_003") %>% 
  addCircleMarkers(lng = 3.14, lat = 42.49, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_014") %>% 
  addCircleMarkers(lng = 5.1746, lat = 43.22639, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_022") %>% 
  addCircleMarkers(lng = 23.2538, lat = 59.8822, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_030") %>% 
  addCircleMarkers(lng = -80.09315, lat = 26.10293, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_037") %>% 
  addCircleMarkers(lng = -79.89954, lat = 32.7524, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_039") %>% 
  addCircleMarkers(lng = 13.33189, lat = 45.325568, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_049") %>% 
  addCircleMarkers(lng = -69.6409, lat = 43.8444, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_054") %>% 
  addCircleMarkers(lng = -69.5781, lat = 43.8604, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_055") %>% 
  addCircleMarkers(lng = -79.16763,	lat = 33.32306, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_060") %>% 
  addCircleMarkers(lng = 10, lat = 54.8333, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_072") %>% 
  addCircleMarkers(lng = 12.935,	lat = 43.9475, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_076") %>% 
  addCircleMarkers(lng = 13.0731, lat = 43.8514, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_077") %>% 
  addCircleMarkers(lng = 13.71003, lat = 45.70092, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_099") %>% 
  addCircleMarkers(lng = 32.954, lat = 32.822, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_123") %>% 
  addCircleMarkers(lng = 34.843, lat = 32.0694, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_132") %>% 
  addCircleMarkers(lng = 5.11504, lat = 60.16121, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_141") %>% 
  addCircleMarkers(lng = -81.01667, lat = 31.98282, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_143") %>% 
  addCircleMarkers(lng = -54.266, lat = -34.616, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_149") %>% 
  addCircleMarkers(lng = -54.2752, lat = -34.666, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_150") %>% 
  addCircleMarkers(lng = -63.6403, lat = 44.6936, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_152") %>% 
  addCircleMarkers(lng = -4.552, lat = 48.359, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_159") %>% 
  addMeasure(position = "bottomright", primaryLengthUnit = "kilometers") %>% 
  addScaleBar(position = "bottomleft")
saveWidget(stationsmap, file = "mapa.html")
```

#Datasets import
```{r datasets, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
CORE <- read.csv("/Users/Artemis/Documents/GitHub/CORE/Camilo/DADA2/seqtab_nonchim.csv", 
                 header = TRUE, 
                 sep = ";", 
                 skip = 0, 
                 fill = TRUE, 
                 row.names = 1)
CORE <- apply(CORE, 2, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
samples <- c("C1A17", "C1F18", "C1A18", "C2A17", "C2F18", "C2A18", "C3A17", "C3F18", "C3A18", "C4A17", "C4F18", "C4A18", 
             "F1A17", "F1F18", "F1A18", "F2A17", "F2F18", "F2A18", "F3A17", "F3F18", "F3A18", "F4A17", "F4F18", "F4A18", 
             "H1A17", "H1F18", "H1A18", "H2A17", "H2F18", "H2A18", "H3A17", "H3F18", "H3A18", "H4A17", "H4F18", "H4A18", 
             "P1F18", "P1A18", "P2F18", "P3F18", "P4F18", 
             "Q1A17", "Q1F18", "Q2A17", "Q2F18", "Q3A17", "Q3F18", "Q3A18", "Q4A17", "Q4F18", "Q4A18", 
             "L1A17", "L1F18", "L1A18", "L2A17", "L2F18", "L2A18", "L3A17", "L3F18", "L3A18", "L4A17", "L4F18", "L4A18")
rownames(CORE) <- samples
write.csv2(CORE, "CORE_ASV_Abundance.csv")

TAXA <- read.csv("/Users/Artemis/Documents/GitHub/CORE/Camilo/DADA2/taxa.csv", 
                 header = TRUE, 
                 sep = ";", 
                 skip = 0) %>% 
  dplyr::rename(Seq = X) %>%
  add_column(ASV = c(str_glue("ASV000{1:9}"), 
                     str_glue("ASV00{10:99}"), 
                     str_glue("ASV0{100:999}"), 
                     str_glue("ASV{1000:6192}")), 
             .after = "Seq")
rownames(TAXA) <- TAXA[,1]
write.csv2(TAXA, "CORE_TAXA.csv")

taxa.dflt <- read.csv("D:/Documents/GitHub/CORE/Camilo/DADA2/taxa_pr2_default.csv", header = TRUE, skip = 0, sep = ";") %>% 
  dplyr::rename(Seq = X) %>% 
  add_column(ASV = c(str_glue("ASV000{1:9}"), 
                     str_glue("ASV00{10:99}"), 
                     str_glue("ASV0{100:999}"), 
                     str_glue("ASV{1000:6192}")), 
             .after = "Seq")
rownames(taxa.dflt) <- taxa.dflt[,1]

cautious <- read.csv("D:/Documents/GitHub/CORE/Camilo/DADA2/taxa_pr2_cautious.csv", header = TRUE, skip = 0, sep = ";") %>% 
  dplyr::rename(Seq = X) %>% 
  add_column(ASV = c(str_glue("ASV000{1:9}"), 
                     str_glue("ASV00{10:99}"), 
                     str_glue("ASV0{100:999}"), 
                     str_glue("ASV{1000:6192}")), 
             .after = "Seq")
rownames(cautious) <- cautious[,1]

stringent <- read.csv("D:/Documents/GitHub/CORE/Camilo/DADA2/taxa_pr2_stringent.csv", header = TRUE, skip = 0, sep = ";") %>% 
  dplyr::rename(Seq = X) %>% 
  add_column(ASV = c(str_glue("ASV000{1:9}"), 
                     str_glue("ASV00{10:99}"), 
                     str_glue("ASV0{100:999}"), 
                     str_glue("ASV{1000:6192}")), 
             .after = "Seq")
rownames(stringent) <- stringent[,1]

print(all(colnames(CORE)%in%rownames(TAXA))) #If TRUE you can continue
print(all(colnames(CORE)%in%rownames(taxa.dflt)))
print(all(colnames(CORE)%in%rownames(cautious)))
print(all(colnames(CORE)%in%rownames(stringent)))

```

#First ASV filter, excluding some NAs
```{r first filter, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Me deshago de las secuencias de ASV que no fueron asignadas a nivel de Reino y Supergrupo
unassigned <- TAXA[rowSums(is.na(TAXA[, c(3,4)])) > 0, ]
nada <- TAXA[rowSums(is.na(TAXA[3])) > 0, ]
na.seq <- unassigned[,1]
mTAXA <- TAXA[!(row.names(TAXA) %in% all_of(na.seq)),]
write.csv2(mTAXA, "Filtered_CORE_TAXA.csv")
mCORE <- dplyr::select(CORE, -all_of(na.seq))
write.csv2(mCORE, "Filtered_CORE_ASV_Abundance.csv")

print(all(colnames(mCORE)%in%rownames(mTAXA))) #If TRUE you can continue
```

```{r}
#Me deshago de las secuencias de ASV que no fueron asignadas a nivel de Reino y Supergrupo
una2 <- taxa.dflt[rowSums(is.na(taxa.dflt[, c(3,4)])) > 0, ]
nada2 <- taxa.dflt[rowSums(is.na(taxa.dflt[3])) > 0, ]
na.seq2 <- una2[,1]
edefault <- taxa.dflt[!(row.names(taxa.dflt) %in% na.seq2),]
write.csv2(edefault, "na_filtered_taxa_default.csv")
default.abund <- dplyr::select(CORE, -all_of(na.seq2))
write.csv2(default.abund, "na_filtered_asv_abundance_default.csv")

print(all(colnames(default.abund)%in%rownames(edefault))) #If TRUE you can continue
```

```{r}
una3 <- cautious[rowSums(is.na(cautious[, c(3,4)])) > 0, ]
nada3 <- cautious[rowSums(is.na(cautious[3])) > 0, ]
na.seq3 <- una3[,1]
ecautious <- cautious[!(row.names(cautious) %in% na.seq3),]
write.csv2(ecautious, "na_filtered_taxa_cautious.csv")
cautious.abund <- dplyr::select(CORE, -all_of(na.seq3))
write.csv2(cautious.abund, "na_filtered_asv_abundance_cautious.csv")

print(all(colnames(cautious.abund)%in%rownames(ecautious))) #If TRUE you can continue
```

```{r}
una4 <- stringent[rowSums(is.na(stringent[, c(3,4)])) > 0, ]
nada4 <- stringent[rowSums(is.na(stringent[3])) > 0, ]
na.seq4 <- una4[,1]
estringent <- stringent[!(row.names(stringent) %in% na.seq4),]
write.csv2(estringent, "na_filtered_taxa_stringent.csv")
stringent.abund <- dplyr::select(CORE, -all_of(na.seq4))
write.csv2(stringent.abund, "na_filtered_asv_abundance_stringent.csv")

print(all(colnames(stringent.abund)%in%rownames(estringent))) #If TRUE you can continue
```


#Rarefaction (if necessary)
<https://www.nature.com/articles/s41598-021-01636-1>
```{r rarefaction, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
rare.all <- sort(rowSums(mCORE)) #To identify the sample with the smallest number of observations, which will be used as the number of observations to rarefy samples

rrfy <- rarefy(mCORE, rare.all[1]) #rarefaction use the smallest number of observations per sample to extrapolate the expected number if all other samples only had that number of observations
rrfy #Gives an "expected" rarefied number of species (not observations) if only "rare.all[1]" individuals were present per sample

png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_1_rarecurve_mCORE.png", width = 12, height = 6, units = "in", res = 600)
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(0, 0, 0, 0))
rarecurve(x = mCORE, col = "orange", lwd = 2, las = 1, label = TRUE, step = 10, cex = 0.5)
dev.off()

rareCORE <- as.data.frame(rrarefy(mCORE, rrfy[1]))
write.csv2(rareCORE, file = "Rarefacted_filt_CORE_ASV_Abundance.csv")
```

#Dataframes joint
```{r joint, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
PreU <- as.data.frame(t(stringent.abund))
PreU <- mutate(PreU, Seq = all_of(rownames(PreU)), .before = "C1A17")
PreU <- mutate(PreU, 
               Chanaral = rowSums(PreU[2:13]), 
               Flamenco = rowSums(PreU[14:25]), 
               Huasco = rowSums(PreU[26:37]), 
               Pta.Choros = rowSums(PreU[38:42]), 
               Quintero = rowSums(PreU[43:52]), 
               LasCruces = rowSums(PreU[53:64]), 
               Total = rowSums(PreU[2:64])
               )
Pre.ATs <- inner_join(PreU, estringent, by = "Seq") %>% relocate(ASV, .after = Seq)
rownames(Pre.ATs) <- all_of(Pre.ATs[,1])
write.csv2(Pre.ATs, "D:/Documents/GitHub/CORE/Camilo/Analisis/stringent_taxonomic_and_abundance_hcs.csv")

Union <- as.data.frame(t(stringent.abund))
Union <- mutate(Union, Seq = all_of(rownames(Union)), .before = "C1A17")
Union <- mutate(Union, 
                Chanaral = rowSums(Union[2:13]), 
                Flamenco = rowSums(Union[14:25]), 
                Huasco = rowSums(Union[26:37]), 
                Pta.Choros = rowSums(Union[38:42]), 
                Quintero = rowSums(Union[43:52]), 
                LasCruces = rowSums(Union[53:64]), 
                Total = rowSums(Union[2:64])
                )
ATs <- inner_join(Union, estringent, by = "Seq") %>% relocate(ASV, .after = Seq)
rownames(ATs) <- all_of(ATs[,1])
write.csv2(ATs, "D:/Documents/GitHub/CORE/Camilo/Analisis/taxonomic_and_abundance_stringent_data.csv")
```

#UpSet preparation
```{r upset prep, echo=FALSE,message=FALSE, warning=FALSE, include=FALSE}
pre.asv <- Pre.ATs[,2]
pre.ed <- Pre.ATs[, -c(2,72:80)]
rownames(pre.ed) <- pre.asv
write.csv2(pre.ed, "Original_Edited_Taxonomic_and_Abundance_HCS.csv")
Pre.APATs <- pre.ed[, -1]
Pre.APATs <- vegan::decostand(Pre.APATs, method = "pa")
Pre.APATs <- add_column(Pre.APATs, Seq = all_of(pre.ed$Seq), .before = "C1A17")
write.csv2(Pre.APATs, "Original_Absence_Presence_HCS.csv")

asv <- ATs[,2]
edited <- ATs[, -c(2,73:81)]
rownames(edited) <- asv
write.csv2(edited, "D:/Documents/GitHub/CORE/Camilo/Analisis/edited_taxonomic_and_abundance_stringent.csv")
APATs <- edited[, -1]
APATs <- vegan::decostand(APATs, method = "pa")
APATs <- add_column(APATs, Seq = all_of(edited$Seq), .before = "C1A17")
write.csv2(APATs, "D:/Documents/GitHub/CORE/Camilo/Analisis/absence_presence_stringent.csv")
```

#UpSet
##Complete UpSet
```{r complete, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
pre.ap <- read.csv("Original_Absence_Presence_HCS.csv", 
                   header = TRUE, 
                   sep = ";", 
                   dec = ".", 
                   skip = 0)

aus.pres <- read.csv("D:/Documents/GitHub/CORE/Camilo/Analisis/absence_presence_stringent.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".", 
                     skip = 0)

png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/figura_a_complete_UpSet_stringent_2.png", width = 50, height = 23, units = "in", res = 300)
upset(aus.pres, 
      nsets = 6, 
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      empty.intersections = "on", 
      keep.order = TRUE, 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 2, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site"
      )
dev.off()
```

##Shorter UpSet
```{r shorter, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/fig_b_shorter_UpSet_stringent_2.png", width = 40, height = 21, units = "in", res = 300)
upset(aus.pres, 
      nsets = 6,
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      intersections = list("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral", 
                           list("Chanaral", "Flamenco"), 
                           list("Huasco", "Pta.Choros"), 
                           list("Quintero", "LasCruces"), 
                           list("Chanaral", "Huasco"), 
                           list("Chanaral", "Quintero"),
                           list("Huasco", "Quintero"),
                           list("Flamenco", "Pta.Choros"),
                           list("Flamenco", "LasCruces"),
                           list("Pta.Choros", "LasCruces"),
                           list("Quintero", "LasCruces"),
                           list("Chanaral", "Huasco", "Quintero"), 
                           list("Flamenco", "Pta.Choros", "LasCruces"),
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros"),  
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "LasCruces"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces")
                           ),
      empty.intersections = "on", 
      keep.order = TRUE, 
      query.legend = "top", 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 2, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site")
dev.off()
```

##Selected UpSet
```{r selected, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Modify this according to selected intersections from previous UpSet
png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/figura_c_shorter_UpSet_color_coded_stringent_2.png", width = 40, height = 17, units = "in", res = 200)
upset(aus.pres, 
      nsets = 6,
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      intersections = list("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral", 
                           list("Chanaral", "Flamenco"), 
                           list("Huasco", "Pta.Choros"), 
                           list("Quintero", "LasCruces"), 
                           list("Chanaral", "Huasco"), 
                           list("Chanaral", "Quintero"),
                           list("Huasco", "Quintero"),
                           list("Flamenco", "Pta.Choros"),
                           list("Flamenco", "LasCruces"),
                           list("Pta.Choros", "LasCruces"),
                           list("Quintero", "LasCruces"),
                           list("Chanaral", "Huasco", "Quintero"), 
                           list("Flamenco", "Pta.Choros", "LasCruces"),
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros"),  
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "LasCruces"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces")
                           ),
      empty.intersections = "on", 
      keep.order = TRUE, 
      query.legend = "top", 
      queries = list(list(query = intersects, params = "Chanaral", color = "#FF8811", active = TRUE, query.name = "Unique ChaÃ±aral ASV"), 
                     list(query = intersects, params = "Flamenco", color = "#F4D06F", active = TRUE, query.name = "Unique Flamenco ASV"), 
                     list(query = intersects, params = "Huasco", color = "#392F5A", active = TRUE, query.name = "Unique Huasco ASV"), 
                     list(query = intersects, params = "Pta.Choros", color = "#403286", active = TRUE, query.name = "Unique Punta Choros ASV"), 
                     list(query = intersects, params = "Quintero", color = "#18E0BD", active = TRUE, query.name = "Unique Quintero ASV"), 
                     list(query = intersects, params = "LasCruces", color = "#80EB9F", active = TRUE, query.name = "Unique Las Cruces ASV"), 
                     list(query = intersects, params = list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces"), color = "#EF233C", active = TRUE, query.name = "Total ASV shared")
                     ), 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 3, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site")
dev.off()
```

#ASV identification
##Shared
```{r shared, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
pre.sha <- pre.ap %>% dplyr::filter(Chanaral ==1 & Flamenco == 1 & Huasco == 1 & Pta.Choros ==1 & Quintero == 1 & LasCruces == 1)
pre.sha.asv <- dplyr::select(stringent.abund, pre.sha$Seq)
write.csv2(pre.sha.asv, "stringent_unfiltered_shared_asv_abundance.csv")
  
shared <- aus.pres %>% dplyr::filter(Chanaral == 1 & Flamenco == 1 & Huasco == 1 & Pta.Choros == 1 & Quintero == 1 & LasCruces == 1)
shared.asv <- dplyr::select(stringent.abund, all_of(shared$Seq))
write.csv2(shared.asv, "stringent_shared_asv_abundance.csv")
```

##Uniques
###ChaÃ±aral
```{r chaÃ±aral, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
pre.cha <- pre.ap %>% dplyr::filter(Chanaral == 1)
pre.cha.asv <- dplyr::select(CORE, all_of(pre.cha$Seq))
pre.cha.asv <- pre.cha.asv[c(1:12),]
write.csv2(as.data.frame(t(pre.cha.asv)), "Original_Unfiltered_Chanaral_HCS_ASV_Abundance.csv")

u.pre.cha <- pre.ap %>% dplyr::filter(Chanaral == 1 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.cha.asv <- dplyr::select(CORE, all_of(u.pre.cha$Seq))
u.pre.cha.asv <- u.pre.cha.asv[c(1:12),]
write.csv2(u.pre.cha.asv, "Original_Unfiltered_Chanaral_Unique_HCS_ASV_Abundance.csv")

chanaral <- aus.pres %>% dplyr::filter(Chanaral == 1 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
cha.asv <- dplyr::select(stringent.abund, all_of(chanaral$Seq))
write.csv2(cha.asv, "stringent_chanaral_unique_asv_abundance.csv")
ahc <- as.data.frame(t(cha.asv))
col <- colSums(ahc)
col
sum(col)
```

###Flamenco
```{r flamenco,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
pre.fla <- pre.ap %>% dplyr::filter(Flamenco == 1)
pre.fla.asv <- dplyr::select(CORE, all_of(pre.fla$Seq))
pre.fla.asv <- pre.fla.asv[c(13:24),]
write.csv2(as.data.frame(t(pre.fla.asv)), "Original_Unfiltered_Flamenco_HCS_ASV_Abundance.csv")

u.pre.fla <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 1 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.fla.asv <- dplyr::select(CORE, all_of(u.pre.fla$Seq))
u.pre.fla.asv <- u.pre.fla.asv[c(13:24),]
write.csv2(u.pre.fla.asv, "Original_Unfiltered_Flamenco_HCS_Unique_ASV_Abundance.csv")

flamenco <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 1 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
fla.asv <- dplyr::select(stringent.abund, all_of(flamenco$Seq))
write.csv2(fla.asv, "stringent_flamenco_unique_asv_abundance.csv")
ahc <- as.data.frame(t(fla.asv))
col <- colSums(ahc)
col
sum(col)
```

###Huasco
```{r Huasco, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
pre.hu <- pre.ap %>% dplyr::filter(Huasco == 1)
pre.hu.asv <- dplyr::select(CORE, all_of(pre.hu$Seq))
pre.hu.asv <- pre.hu.asv[c(25:36),]
write.csv2(as.data.frame(t(pre.hu.asv)), "Original_Unfiltered_Huasco_HCS_ASV_Abundance.csv")

u.pre.hu <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 1 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.hu.asv <- dplyr::select(CORE, all_of(u.pre.hu$Seq))
u.pre.hu.asv <- u.pre.hu.asv[c(25:36),]
write.csv2(u.pre.hu.asv, "Original_Unfiltered_Huasco_Unique_HCS_ASV_Abundance.csv")

huasco <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 1 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
hu.asv <- dplyr::select(stringent.abund, all_of(huasco$Seq))
write.csv2(hu.asv, "stringent_huasco_unique_asv_abundance.csv")
ahc <- as.data.frame(t(hu.asv))
col <- colSums(ahc)
col
sum(col)
```

###Punta de Choros
```{r pta. choros, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
pre.pch <- pre.ap %>% dplyr::filter(Pta.Choros == 1)
pre.pch.asv <- dplyr::select(CORE, all_of(pre.pch$Seq))
pre.pch.asv <- pre.pch.asv[c(37:41),]
write.csv2(as.data.frame(t(pre.pch.asv)), "Original_Unfiltered_Punta_Choros_HCS_ASV_Abundance.csv")

u.pre.pch <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 1 & Quintero == 0 & LasCruces == 0)
u.pre.pch.asv <- dplyr::select(CORE, all_of(u.pre.pch$Seq))
u.pre.pch.asv <- u.pre.pch.asv[c(37:41),]
write.csv2(u.pre.pch.asv, "Original_Unfiltered_Punta_Choros_HCS_Unique_ASV_Abundance.csv")

choros <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 1 & Quintero == 0 & LasCruces == 0)
pch.asv <- dplyr::select(stringent.abund, all_of(choros$Seq))
write.csv2(pch.asv, "stringent_punta_choros_unique_asv_abundance.csv")
ahc <- as.data.frame(t(pch.asv))
col <- colSums(ahc)
col
sum(col)
```

###Quintero
```{r quintero, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
pre.qin <- pre.ap %>% dplyr::filter(Quintero == 1)
pre.qin.asv <- dplyr::select(CORE, all_of(pre.qin$Seq))
pre.qin.asv <- pre.qin.asv[c(42:51),]
write.csv2(as.data.frame(t(pre.qin.asv)), "Original_Unfiltered_Quintero_HCS_ASV_Abundance.csv")

u.pre.qin <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 1 & LasCruces == 0)
u.pre.qin.asv <- dplyr::select(CORE, all_of(u.pre.qin$Seq))
u.pre.qin.asv <- u.pre.qin.asv[c(42:51),]
write.csv2(u.pre.qin.asv, "Original_Unfiltered_Quintero_HCS_Unique_ASV_Abundance.csv")

quintero <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 1 & LasCruces == 0)
qin.asv <- dplyr::select(stringent.abund, all_of(quintero$Seq))
write.csv2(qin.asv, "stringent_quintero_unique_asv_abundance.csv")
ahc <- as.data.frame(t(qin.asv))
col <- colSums(ahc)
col
sum(col)
```

###Las Cruces
```{r las cruces, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
pre.lc <- pre.ap %>% dplyr::filter(LasCruces == 1)
pre.lc.asv <- dplyr::select(CORE, all_of(pre.lc$Seq))
pre.lc.asv <- pre.lc.asv[c(52:63),]
write.csv2(as.data.frame(t(pre.lc.asv)), "Original_Unfiltered_Las_Cruces_HCS_ASV_Abundance.csv")

u.pre.lc <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 1)
u.pre.lc.asv <- dplyr::select(CORE, all_of(u.pre.lc$Seq))
u.pre.lc.asv <- u.pre.lc.asv[c(52:63),]
write.csv2(u.pre.lc.asv, "Original_Unfiltered_Las_Cruces_HCS_Unique_ASV_Abundance.csv")

cruces <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 1)
lc.asv <- dplyr::select(stringent.abund, all_of(cruces$Seq))
write.csv2(lc.asv, "stringent_las_cruces_unique_asv_abundance.csv")
ahc <- as.data.frame(t(lc.asv))
col <- colSums(ahc)
col
sum(col)
```

##Others
```{r others, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
others <- dplyr::select(CORE, -all_of(pre.sha$Seq)) %>% 
  dplyr::select(-all_of(u.pre.cha$Seq)) %>% 
  dplyr::select(-all_of(u.pre.fla$Seq)) %>% 
  dplyr::select(-all_of(u.pre.hu$Seq)) %>% 
  dplyr::select(-all_of(u.pre.pch$Seq)) %>% 
  dplyr::select(-all_of(u.pre.qin$Seq)) %>% 
  dplyr::select(-all_of(u.pre.lc$Seq))
write.csv2(others, "Original_Unfiltered_HCS_Others_ASV_Abundance.csv")
inv.others <- as.data.frame(t(others))
write.csv2(inv.others, "Inverted_Original_Unfiltered_HCS_Others_ASV_Abundance.csv")

rest <- dplyr::select(stringent.abund, -all_of(shared$Seq)) %>% 
  dplyr::select(-all_of(chanaral$Seq)) %>% 
  dplyr::select(-all_of(flamenco$Seq)) %>% 
  dplyr::select(-all_of(huasco$Seq)) %>% 
  dplyr::select(-all_of(choros$Seq)) %>% 
  dplyr::select(-all_of(quintero$Seq)) %>% 
  dplyr::select(-all_of(cruces$Seq))
write.csv2(rest, "stringent_nonshared_asv_abundance.csv")
crest <- as.data.frame(t(rest))
write.csv2(crest, "inverted_stringent_nonshared_asv_abundance.csv")
```

##Managing the different ASV abundances
There are 341 shared ASV from unfiltered CORE
First we are going to identify the total abundance of these ASV and their abundance per site
Total Shared ASV Abundance = *2474548*
ChaÃ±aral Shared ASV Abundance = *420995*
Flamenco Shared ASV Abundance = *431629*
Huasco Shared ASV Abundance = *571797*
Pta. Choros Shared ASV Abundance = *204389*
Quintero Shared ASV Abundance = *401248*
Las Cruces Shared ASV Abundance = *444490*

Then we are going to get the abundance of the Rest of ASV per site, by extracting Uniques and Shared ASV sequences
```{r rest abundance, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#ChaÃ±aral
pre.rest.cha <- dplyr::select(pre.cha.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.cha$Seq))
write.csv2(as.data.frame(t(pre.rest.cha)), "Original_Unfiltered_Other_Chanaral_HCS_ASV_Abundance.csv")

#Flamenco
pre.rest.fla <- dplyr::select(pre.fla.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.fla$Seq))
write.csv2(as.data.frame(t(pre.rest.fla)), "Original_Unfiltered_Other_Flamenco_HCS_ASV_Abundance.csv")

#Huasco
pre.rest.hu <- dplyr::select(pre.hu.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.hu$Seq))
write.csv2(as.data.frame(t(pre.rest.hu)), "Original_Unfiltered_Other_Huasco_HCS_ASV_Abundance.csv")

#Pta.Choros
pre.rest.pch <- dplyr::select(pre.pch.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.pch$Seq))
write.csv2(as.data.frame(t(pre.rest.pch)), "Original_Unfiltered_Other_Pta_Choros_HCS_ASV_Abundance.csv")

#Quintero
pre.rest.qin <- dplyr::select(pre.qin.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.qin$Seq))
write.csv2(as.data.frame(t(pre.rest.qin)), "Original_Unfiltered_Other_Quintero_HCS_ASV_Abundance.csv")

#Las Cruces
pre.rest.lc <- dplyr::select(pre.lc.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.lc$Seq))
write.csv2(as.data.frame(t(pre.rest.lc)), "Original_Unfiltered_Other_Las_Cruces_HCS_ASV_Abundance.csv")
```

#Total ASV abundances
```{r}
full <- as.data.frame(t(stringent.abund))
full <- dplyr::mutate(full, 
                      cha = rowSums(full[c(1:12)]), 
                      fla = rowSums(full[c(13:24)]), 
                      hu = rowSums(full[c(25:36)]), 
                      pc = rowSums(full[c(37:41)]), 
                      qin = rowSums(full[c(42:51)]), 
                      lc = rowSums(full[c(52:63)])
                      )
full <- full[,c(64:69)] %>% t() %>% as.data.frame()
full <- dplyr::mutate(full, total = rowSums(full[c(1:5948)]))
full <- full[,5949]
```

#Detailed ASVs
To differentiate between types of ASV
```{r detailed, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
detailed <- read.csv("detailed_total_ASV_abundance.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".", 
                     skip = 0, 
                     row.names = 1)
detailed <- add_column(detailed, Site = rownames(detailed), .before = "Unique", .name_repair = "minimal")
detailed$Site <- factor(detailed$Site, levels = detailed$Site)
long <- reshape2::melt(detailed, id.vars = "Site", variable.name = "Type")

det.string <- read.csv("stringent_detailed_total_asv_abundance.csv", header = TRUE, sep = ";", dec = ".", skip = 0, row.names = 1)
det.string <- add_column(det.string, Site = rownames(det.string), .before = "Core", .name_repair = "minimal")
det.string <- det.string[,-6]
det.string$Site <- factor(det.string$Site, levels = det.string$Site)
det.string <- dplyr::rename(.data = det.string, "Non-Core" = "Shared")
#dslong <- reshape2::melt(det.string, id.vars = "Site", variable.name = "Type")
dslong <- gather(det.string, "Type", "Abundance", 2:5)
dslong$Type <- factor(dslong$Type, levels = c("Unique", "Rest", "Non-Core", "Core"))
```

#Relative Abundance for ASV types
```{r, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
det <- ggplot(long, 
              aes(x = Site, 
                  y = value, 
                  fill = Type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "Sites", 
       y = "Relative Abundance", 
       title = "Relative contribution of each ASV type") + 
  scale_fill_manual(values = c("#2B2D42", "#EF233C", "#9CAFB7")) + 
  theme_ipsum(base_size = 22, 
              axis_title_size = 25, 
              plot_title_size = 25) + 
  theme(legend.position = "bottom", legend.direction = "horizontal")
det.legend <- cowplot::get_legend(det)
det <- det + 
  theme(legend.position = "none")
ggsave(plot = det, 
       filename = "Figura_5_relative_contribution_ASV_type.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 12, 
       height = 15, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(det.legend), 
       filename = "Figura_5_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 7, 
       height = 3, 
       dpi = 600)
```


```{r, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
detsng <- ggplot(dslong, aes(x = Site, y = Abundance, fill = Type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "Sites", y = "Relative Abundance", title = "Relative contribution of each ASV type per site") + 
  scale_fill_manual(values = c("#9CAFB7", "#2B2D42", "#9E1728", "#EF233C")) + 
  theme_ipsum_rc(base_size = 22, axis_title_size = 25, plot_title_size = 25) + 
  theme(legend.position = "bottom", legend.direction = "horizontal")

ggsave(plot = detsng, 
       filename = "fig_e_stringent_relative_contribution_asv_type.png", 
       path = "./Figuras/", 
       width = 12, 
       height = 15, 
       dpi = 400)
```


#Taxonomy function
```{r tax.sum, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
Tax.sum <- function(OTU.Table, Tax.Table, Tax.lvl ){
  z <- NULL
  y <- NULL
  for (i in 1:length(unique(Tax.Table[colnames(OTU.Table),Tax.lvl]))) {
    if (length(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])!=length(rownames(OTU.Table))) {
      z <- which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])
      y <- cbind(y, apply(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])], 1, function(x) sum(x)))
    } else {
      y <- cbind(y, OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])
    }
  }
  colnames(y) <- unique(Tax.Table[colnames(OTU.Table),Tax.lvl])
  invisible((y))
}
```


```{r}
phsynth <- estringent #5948
#Ochrophyta = Stramenopiles
phsynth <- dplyr::filter(phsynth, Division == "Chlorophyta" | Division == "Stramenopiles" | Division == "Cryptophyta" | Division == "Cryptophyta:nucl" | Division == "Haptophyta" | Division == "Kathablepharidacea" | Division == "Rhodophyta")
#Me quedo con 2416 ASV
phsynth.abund <- dplyr::select(stringent.abund, all_of(phsynth$Seq))
div.phsynth <- Tax.sum(phsynth.abund, phsynth, 5) %>% (t) %>% as.data.frame() %>% add_column(Color = c("#90ED90", "#CDAE94", "#6CA6CD", "#7EFFD3", "#C577F9", "#F9A555", "#5888A8"))
div.phsynth <- dplyr::mutate(div.phsynth, 
                             CHA = rowSums(div.phsynth[c(1:12)]), 
                             FLA = rowSums(div.phsynth[c(13:24)]), 
                             HUA = rowSums(div.phsynth[c(25:36)]), 
                             PCH = rowSums(div.phsynth[c(37:41)]), 
                             QUI = rowSums(div.phsynth[c(42:51)]), 
                             LCS = rowSums(div.phsynth[c(52:63)]), 
                             Total = rowSums(div.phsynth[c(1:63)]), 
                             .after = "L4A18")
write.csv2(div.phsynth, "./stringent_phylum_photosynthetic_asv_abundance_and_color.csv")
write.csv2(phsynth.abund, "./stringent_phosynthetic_asv_abundance.csv")
write.csv2(phsynth, "./stringent_photosynthetic_asc_taxa.csv")
```


#Treemaps
```{r complete}
png("./Figuras/fig_f_treemap_all_sites.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "Total", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for complete dataset", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r chanaral}
png("./Figuras/fig_f_1_treemap_chanaral.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "CHA", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for ChaÃ±aral", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r flamenco}
png("./Figuras/fig_f_2_treemap_flamenco.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "FLA", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for Flamenco", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r huasco}
png("./Figuras/fig_f_3_treemap_huasco.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "HUA", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for Huasco", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r pta.choros}
png("./Figuras/fig_f_4_treemap_punta_choros.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "PCH", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for Punta de Choros", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r quintero}
png("./Figuras/fig_f_5_treemap_quintero.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "QUI", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for Quintero", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```


```{r las cruces}
png("./Figuras/fig_f_6_treemap_las_cruces.png", width = 17, height = 15, units = "in", res = 400)
treemap::treemap(read.csv("./stringent_phylum_photosynthetic_asv_abundance_and_color.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0), 
                 index = "X", 
                 vSize = "LCS", 
                 type = "color", 
                 vColor = "Color", 
                 position.legend = "none", 
                 fontsize.labels = 55, 
                 title = "Photosynthetic ASV distribution (counts) for Las Cruces", 
                 fontsize.title = 42,
                 title.legend = NA, 
                 border.col = NA)
dev.off()
```








#Static map
```{r static, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
mapping <- read.csv("Mapping_Data.csv", 
                    header = TRUE, 
                    sep = ";", 
                    dec = ",", 
                    skip = 0, 
                    row.names = 1)
world <- map_data("world")
Worldo <- filter(world, region != "Antarctica") %>% fortify()
map_v1 <- ggplot() + 
  geom_map(data = Worldo, 
           map = Worldo, 
           aes(long, 
               lat, 
               map_id = region)
           ) + 
  geom_point(data = mapping, 
             aes(Longitude, 
                 Latitude, 
                 color = Color, 
                 size = Total.ASV.Abundance), 
             alpha = 1
             ) + 
  theme_bw() + 
  theme(legend.position = "none")

ggsave(plot = map_v1, 
       filename = "mapa_primera_version.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/", 
       limitsize = FALSE, 
       width = 27, 
       height = 15, 
       dpi = 600)
```

#Taxonomy function
```{r tax.sum, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
Tax.sum <- function(OTU.Table, Tax.Table, Tax.lvl ){
  z <- NULL
  y <- NULL
  for (i in 1:length(unique(Tax.Table[colnames(OTU.Table),Tax.lvl]))) {
    if (length(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])!=length(rownames(OTU.Table))) {
      z <- which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])
      y <- cbind(y, apply(OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])], 1, function(x) sum(x)))
    } else {
      y <- cbind(y, OTU.Table[,which(Tax.Table[colnames(OTU.Table),Tax.lvl]==unique(Tax.Table[colnames(OTU.Table),Tax.lvl])[i])])
    }
  }
  colnames(y) <- unique(Tax.Table[colnames(OTU.Table),Tax.lvl])
  invisible((y))
}
```

#Abundance at selected taxonomy level: Phylum
```{r}
Phylum <- Tax.sum(mCORE, mTAXA, 5) %>% as.data.frame()
Phylum <- Phylum[,-22]
colnames(Phylum)[c(6,13)] <- c("A","B")
Phylum <- mutate(Phylum, Cryptophyta = rowSums(Phylum[c(6,13)]))
Phylum <- Phylum[,-c(6,13)] %>% t() %>% as.data.frame()
Phylum <- dplyr::mutate(Phylum, 
                        Chanaral = rowSums(Phylum[c(1:12)]), 
                        Flamenco = rowSums(Phylum[c(13:24)]), 
                        Huasco = rowSums(Phylum[c(25:36)]), 
                        Pta.Choros = rowSums(Phylum[c(37:41)]), 
                        Quintero = rowSums(Phylum[c(42:51)]), 
                        LasCruces = rowSums(Phylum[c(52:63)]), 
                        Total = rowSums(Phylum[c(1:63)]), 
                        .after = "L4A18")
Phylum <- Phylum[order(Phylum$Total, decreasing = TRUE),]
write.csv2(Phylum, "HCS_total_phylum_abundance.csv")
colored <- Phylum %>% dplyr::mutate(Color = c("#63CB5F", "#472E7C", "#46095D", "#471164", "#482778", "#440154", "#24AA83", 
                                              "#34618D", "#38B977", "#443C84", "#3F4889", "#99D83E", "#414287", "#453581", 
                                              "#8AD647", "#21908C", "#1FA088", "#E2E418", "#B6DE2A", "#21A585", "#29AF7F", 
                                              "#6FCF57", "#57C666", "#26818E", "#482071", "#2D718E", "#A7DB35", "#25858E", 
                                              "#F0E51C", "#375B8D", "#1E9B8A", "#30B47C", "#2F6C8E", "#39558C"), 
                                    .after = "Total")
#These colours were previously selected according to the dataset with most phylums assigned to it (OSDV9 and TARA)
write.csv2(colored, "HCS_color_corrected_total_phylum_abundance_and_color.csv")
```

#Contribution and distribution of ASV at selected taxonomic level: phylum
##Total Contribution and distribution of ASV
```{r total treemap,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_6_HCS_total_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Total", type = "color", vColor = "Color", position.legend = "none", 
                 fontsize.labels = 20, fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for all sites HCS", 
                 title.legend = NA, border.col = NA)
dev.off()

#Respective legend
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_6_legend.png", width = 10, height = 7, units = "in", res = 600)
plot.new()
par(mar = c(0,0,0,0), oma = c(0,0,0,0))
legend("center", 
       legend = read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", skip = 0)[,1],
       cex = 1.2, ncol = 1, fill = colored$Color, x.intersp = 0.3, xjust = 0.3, yjust = 0.5, y.intersp = 1, bty = "n", adj = 0, 
       text.width = 0.3, pt.cex = 0.3)
dev.off()
```

##ChaÃ±aral
```{r treemap chanaral,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_7_HCS_Chanaral_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Chanaral", type = "color", vColor = "Color", position.legend = "none", 
                 fontsize.labels = 20, fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for ChaÃ±aral", 
                 title.legend = NA, border.col = NA)
dev.off()
```

##Flamenco
```{r treemap flamenco,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_8_HCS_Flamenco_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Flamenco", type = "color", vColor = "Color", position.legend = "none", 
                 fontsize.labels = 20, fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for Flamenco", 
                 title.legend = NA, border.col = NA)
dev.off()
```

##Huasco
```{r treemap huasco,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_9_HCS_Huasco_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Huasco", type = "color", vColor = "Color", position.legend = "none", 
                 fontsize.labels = 20, fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for Huasco", 
                 title.legend = NA, border.col = NA)
dev.off()
```

##Punta de Choros
```{r treemap pta. choros, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_10_HCS_Pta_Choros_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Pta.Choros", type = "color", vColor = "Color", position.legend = "none", 
                 fontsize.labels = 20, fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for Punta de Choros",
                 title.legend = NA, border.col = NA)
dev.off()
```

##Quintero
```{r treemap quintero, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_11_HCS_Quintero_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "Quintero", type = "color", vColor = "Color", position.legend = "none", fontsize.labels = 20,
                 fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for Quintero", 
                 title.legend = NA, border.col = NA)
dev.off()
```

##Las Cruces
```{r treemap las cruces, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
png("/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_12_HCS_Las_Cruces_ASV_contribution_distribution_phylum.png", 
    width = 17, height = 15, units = "in", res = 600)
treemap::treemap(read.csv("HCS_color_corrected_total_phylum_abundance_and_color.csv", header = TRUE, sep = ";", dec = ".", skip = 0), 
                 index = "X", vSize = "LasCruces", type = "color", vColor = "Color", position.legend = "none", fontsize.labels = 20,
                 fontsize.title = 30, title = "ASV contribution of total ASV at phylum level for Las Cruces", 
                 title.legend = NA, border.col = NA)
dev.off()
```

#Relative abundance function
```{r}
rltv.Otu.Table <- function(x) {
  x.Data.rltv <- NULL
  for (i in 1:dim(x)[1]) {
    x.Data.rltv <- rbind(x.Data.rltv, x[i,]/apply(x, 1, function(x) sum(x))[i])
  }
  rownames(x.Data.rltv) <- rownames(x)
  invisible(x.Data.rltv)
}
```

#Relative abundance at a selected taxonomic level: Phylum
```{r}
rltv <- Phylum[, -c(64:70)] %>% t() %>% rltv.Otu.Table() %>% as.data.frame()
write.csv2(rltv, "HCS_total_ASV_relative_phylum_abundance_dataframe.csv")
rltv <- add_column(rltv, Sample = rownames(rltv), .before = "Chlorophyta", .name_repair = "minimal")
rltv$Sample <- factor(rltv$Sample, levels = rltv$Sample)
long <- reshape2::melt(rltv, id.vars = "Sample", variable.name = "Phylum")

#For ChaÃ±aral
cha.long <- reshape2::melt(rltv[c(1:12),], id.vars = "Sample", variable.name = "Phylum")
#Flamenco
fla.long <- reshape2::melt(rltv[c(13:24),], id.vars = "Sample", variable.name = "Phylum")
#Huasco
hu.long <- reshape2::melt(rltv[c(25:36),], id.vars = "Sample", variable.name = "Phylum")
#Punta de Choros
pch.long <- reshape2::melt(rltv[c(37:41),], id.vars = "Sample", variable.name = "Phylum")
#Quintero
qin.long <- reshape2::melt(rltv[c(42:51),], id.vars = "Sample", variable.name = "Phylum")
#Las Cruces
lc.long <- reshape2::melt(rltv[c(52:63),], id.vars = "Sample", variable.name = "Phylum")
```

#Plotting relative abundance (new way)
##Complete
```{r complete rltv,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
div <- ggplot(long, aes(x=Sample,
                        y=value, 
                        fill=Phylum)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x="HCS Sites", 
       y="Relative Abundance", 
       title = "Relative abundance at phylum level for total filtered ASV") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, 
              axis_col = "#000000", 
              axis_title_size = 40, 
              plot_title_size = 40) + 
  theme(legend.position = "right", 
        legend.direction = "vertical")
legend <- cowplot::get_legend(div)
div <- div + theme(legend.position = "none")
ggsave(plot = div, 
       filename = "Figura_13_HCS_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 35, 
       height = 21, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(legend), 
       filename = "Figura_13_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Chanaral
```{r chanaral rltv,echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
dcha <- ggplot(cha.long, 
               aes(x = Sample, 
                   y = value, 
                   fill = Phylum)) + 
  geom_bar(position = "fill", 
           stat = "identity") + 
  labs(x = "HCS Sites", 
       y = "Relaive abundance", 
       title = "Total ASV relative abundance at phylum level for ChaÃ±aral") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, 
              axis_col = "#000000", 
              axis_title_size = 30, 
              plot_title_size = 30) + 
  theme(legend.position = "right", 
        legend.direction = "vertical")
cha.leg <- cowplot::get_legend(dcha)
dcha <- dcha + theme(legend.position = "none")
ggsave(plot = dcha,
       filename = "Figura_14_HCS_Chanaral_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 15, 
       height = 17, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(cha.leg), 
       filename = "Figura_14_legend.png",
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Flamenco
```{r flamenco rltv, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
dfla <- ggplot(fla.long, 
               aes(x = Sample, 
                   y = value, 
                   fill = "Phylum")) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "HCS Sites", 
       y = "Relative Abundance", 
       title = "Total ASV relative abundance at phylum level for Flamenco") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, 
              axis_col = "#000000", 
              axis_title_size = 30, 
              plot_title_size = 30) + 
  theme(legend.position = "right", legend.direction = "vertical")
fla.leg <- cowplot::get_legend(dfla)
ggsave(plot = dfla, 
       filename = "Figura_15_HCS_Flamenco_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 15, 
       height = 17, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(fla.leg), 
       filename = "Figura_15_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Huasco
```{r huasco rltv, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
dhu <- ggplot(hu.long, 
              aes(x = Sample, 
                  y = value, 
                  fill = Phylum)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "HCS Sites", 
       y = "Relative abundance", 
       title = "Total ASV relative abundance at phylum level for Huasco") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, 
              axis_col = "#000000", 
              axis_title_size = 30, 
              plot_title_size = 30) + 
  theme(legend.position = "right", legend.direction = "vertical")
hu.leg <- cowplot::get_legend(dhu)
dhu <- dhu + theme(legend.position = "none")
ggsave(plot = dhu, 
       filename = "Figura_16_HCS_Huasco_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/",
       width = 15, 
       height = 17, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(hu.leg), 
       filename = "Figura_16_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Punta de Choros
```{r pta. choros rltv, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
dpch <- ggplot(pch.long, 
               aes(x = Sample, 
                   y = value, 
                   fill = Phylum)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "HCS Sites", 
       y = "Relative Abundance", 
       title = "Total ASV relative abundance at phylum level for Punta de Choros") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, 
              axis_col = "#000000", 
              axis_title_size = 30, 
              plot_title_size = 26) + 
  theme(legend.position = "right", legend.direction = "vertical")
pch.leg <- cowplot::get_legend(dpch)
ggsave(plot = dpch, 
       filename = "Figura_17_HCS_Punta_Choros_phylum_relative_abundance.png",
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 15, 
       height = 17,
       dpi = 600)
ggsave(ggpubr::as_ggplot(pch.leg), 
       filename = "Figura_17_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Quintero
```{r quintero rltv, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
dqin <- ggplot(qin.long, aes(x = Sample, y = value, fill = Phylum)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "HCS Sites", y = "Relative Abundance", title = "Total ASV relative abundance at phylum level for Quintero") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, axis_col = "#000000", axis_title_size = 30, plot_title_size = 30) + 
  theme(legend.position = "right", legend.direction = "vertical")
qin.leg <- cowplot::get_legend(dqin)
ggsave(plot = dqin, 
       filename = "Figura_18_HCS_Quintero_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 15, 
       height = 17, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(qin.leg), 
       filename = "Figura_18_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

##Las Cruces
```{r las cruces rltv, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
dlc <- ggplot(lc.long, aes(x = Sample, y = value, fill = Phylum)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "HCS Sites", y = "Relative Abundance", title = "Total ASV relative abundance at phylum level for Las Cruces") + 
  scale_fill_manual(values = colored$Color) + 
  theme_ipsum(base_size = 22, axis_col = "#000000", axis_title_size = 30, plot_title_size = 30) + 
  theme(legend.position = "right", legend.direction = "vertical")
lc.leg <- cowplot::get_legend(dlc)
ggsave(plot = dlc, 
       filename = "Figura_19_HCS_Las_Cruces_phylum_relative_abundance.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/", 
       width = 15, 
       height = 17, 
       dpi = 600)
ggsave(ggpubr::as_ggplot(lc.leg), 
       filename = "Figura_19_legend.png", 
       path = "/Users/Artemis/Documents/GitHub/CORE/Camilo/Analisis/Figuras/")
```

