---
title: "Core_Microbiota"
author: "Camilo Gálvez A."
output: html_document
---

#Libraries
```{r libraries, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(data.table)
library(Biostrings)
library(DECIPHER)
library(vegan)
library(UpSetR)
library(leaflet)
library(dendextend)
library(treemap)
library(viridis)
library(heatmaply)
library(htmlwidgets)
library(hrbrthemes)
```

#Interactive map
```{r interactive map, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
stationsmap <- leaflet() %>% 
  addTiles() %>% 
  setView(lng = -23.86725804882807, lat = 12.726777153022745, zoom = 2.5) %>% 
  addProviderTiles("Stamen.TonerBackground") %>% 
  addCircleMarkers(lng = -70.667222, lat = -26.224278, color = "#FF8811", radius = 3.5, opacity = 1, label = "Chanaral") %>% 
  addCircleMarkers(lng = -70.7, lat = -26.548611, color = "#F4D06F", radius = 3.5, opacity = 1, label = "Flamenco") %>% 
  addCircleMarkers(lng = -71.210278, lat = -28.336944, color = "#392F5A", radius = 3.5, opacity = 1, label = "Huasco") %>% 
  addCircleMarkers(lng = -71.4975, lat = -29.223333, color = "#403286", radius = 3.5, opacity = 1, label = "Punta de Choros") %>% 
  addCircleMarkers(lng = -71.519083, lat = -32.7555, color = "#18E0BD", radius = 3.5, opacity = 1, label = "Quintero") %>% 
  addCircleMarkers(lng = -71.624688, lat = -33.500600, color = "#80EB9F", radius = 3.5, opacity = 1, label = "Las Cruces") %>% 
  addCircleMarkers(lng = -6.5669, lat = 36.5533, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_004") %>% 
  addCircleMarkers(lng = 1.9378, lat = 37.051, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_007") %>% 
  addCircleMarkers(lng = 2.7996, lat = 41.6686, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_011") %>% 
  addCircleMarkers(lng = 17.4155, lat = 39.8386, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_022") %>% 
  addCircleMarkers(lng = 17.9348, lat = 42.4552, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_024") %>% 
  addCircleMarkers(lng = 19.3905, lat = 39.3888, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_025") %>% 
  addCircleMarkers(lng = 20.1705, lat = 38.4761, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_026") %>% 
  addCircleMarkers(lng = 32.898, lat = 33.9179, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_030") %>% 
  addCircleMarkers(lng = 34.835, lat = 27.16, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_031") %>% 
  addCircleMarkers(lng = 37.2183, lat = 23.36, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_032") %>% 
  addCircleMarkers(lng = 39.8567, lat = 18.4417, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_034") %>% 
  addCircleMarkers(lng = 63.5047, lat = 20.8183, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_036") %>% 
  addCircleMarkers(lng = 69.9776, lat = 14.6059, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_041") %>% 
  addCircleMarkers(lng = 73.8955, lat = 6.0001, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_042") %>% 
  addCircleMarkers(lng = 53.9801, lat = -16.957, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_052") %>% 
  addCircleMarkers(lng = 37.9889, lat = -29.5019, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_064") %>% 
  addCircleMarkers(lng = 26.2868, lat = -35.1728, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_065") %>% 
  addCircleMarkers(lng = 17.9189, lat = -34.9449, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_066") %>% 
  addCircleMarkers(lng = 17.7103, lat = -32.2401, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_067") %>% 
  addCircleMarkers(lng = -35.1803, lat = -20.9354, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_076") %>% 
  addCircleMarkers(lng = -43.2899, lat = -30.1367, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_078") %>% 
  addCircleMarkers(lng = -58.2902, lat = -47.1863, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_082") %>% 
  addCircleMarkers(lng = -85.1545, lat = -5.2529, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_102") %>% 
  addCircleMarkers(lng = -84.5766, lat = 1.9928, color = "#F8417D", radius = 3.5, opacity = 1, label = "TARA_109") %>% 
  addCircleMarkers(lng = -3.9375, lat = 48.7778, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_002") %>% 
  addCircleMarkers(lng = 7.9, lat = 54.18194, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_003") %>% 
  addCircleMarkers(lng = 3.14, lat = 42.49, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_014") %>% 
  addCircleMarkers(lng = 5.1746, lat = 43.22639, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_022") %>% 
  addCircleMarkers(lng = 23.2538, lat = 59.8822, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_030") %>% 
  addCircleMarkers(lng = -80.09315, lat = 26.10293, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_037") %>% 
  addCircleMarkers(lng = -79.89954, lat = 32.7524, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_039") %>% 
  addCircleMarkers(lng = 13.33189, lat = 45.325568, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_049") %>% 
  addCircleMarkers(lng = -69.6409, lat = 43.8444, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_054") %>% 
  addCircleMarkers(lng = -69.5781, lat = 43.8604, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_055") %>% 
  addCircleMarkers(lng = -79.16763,	lat = 33.32306, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_060") %>% 
  addCircleMarkers(lng = 10, lat = 54.8333, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_072") %>% 
  addCircleMarkers(lng = 12.935,	lat = 43.9475, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_076") %>% 
  addCircleMarkers(lng = 13.0731, lat = 43.8514, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_077") %>% 
  addCircleMarkers(lng = 13.71003, lat = 45.70092, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_099") %>% 
  addCircleMarkers(lng = 32.954, lat = 32.822, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_123") %>% 
  addCircleMarkers(lng = 34.843, lat = 32.0694, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_132") %>% 
  addCircleMarkers(lng = 5.11504, lat = 60.16121, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_141") %>% 
  addCircleMarkers(lng = -81.01667, lat = 31.98282, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_143") %>% 
  addCircleMarkers(lng = -54.266, lat = -34.616, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_149") %>% 
  addCircleMarkers(lng = -54.2752, lat = -34.666, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_150") %>% 
  addCircleMarkers(lng = -63.6403, lat = 44.6936, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_152") %>% 
  addCircleMarkers(lng = -4.552, lat = 48.359, color = "#BACC0C", radius = 3.5, opacity = 1, label = "OSD_159") %>% 
  addMeasure(position = "bottomright", primaryLengthUnit = "kilometers") %>% 
  addScaleBar(position = "bottomleft")
saveWidget(stationsmap, file = "mapa.html")
```

#Datasets import
```{r datasets, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
CORE <- read.csv("/Users/Artemis/Documents/GitHub/CORE/Camilo/DADA2/seqtab_nonchim.csv", 
                 header = TRUE, 
                 sep = ";", 
                 skip = 0, 
                 fill = TRUE, 
                 row.names = 1)
CORE <- apply(CORE, 2, function(x) as.numeric(as.integer(x))) %>% as.data.frame()
samples <- c("C1A17", "C1F18", "C1A18", "C2A17", "C2F18", "C2A18", "C3A17", "C3F18", "C3A18", "C4A17", "C4F18", "C4A18", 
             "F1A17", "F1F18", "F1A18", "F2A17", "F2F18", "F2A18", "F3A17", "F3F18", "F3A18", "F4A17", "F4F18", "F4A18", 
             "H1A17", "H1F18", "H1A18", "H2A17", "H2F18", "H2A18", "H3A17", "H3F18", "H3A18", "H4A17", "H4F18", "H4A18", 
             "P1F18", "P1A18", "P2F18", "P3F18", "P4F18", 
             "Q1A17", "Q1F18", "Q2A17", "Q2F18", "Q3A17", "Q3F18", "Q3A18", "Q4A17", "Q4F18", "Q4A18", 
             "L1A17", "L1F18", "L1A18", "L2A17", "L2F18", "L2A18", "L3A17", "L3F18", "L3A18", "L4A17", "L4F18", "L4A18")
rownames(CORE) <- samples
write.csv2(CORE, "CORE_ASV_Abundance.csv")

TAXA <- read.csv("/Users/Artemis/Documents/GitHub/CORE/Camilo/DADA2/taxa.csv", 
                 header = TRUE, 
                 sep = ";", 
                 skip = 0) %>% 
  dplyr::rename(Seq = X) %>%
  add_column(ASV = c(str_glue("ASV000{1:9}"), 
                     str_glue("ASV00{10:99}"), 
                     str_glue("ASV0{100:999}"), 
                     str_glue("ASV{1000:6192}")), 
             .after = "Seq")
rownames(TAXA) <- TAXA[,1]
write.csv2(TAXA, "CORE_TAXA.csv")

print(all(colnames(CORE)%in%rownames(TAXA))) #If TRUE you can continue
```

#First ASV filter, excluding some NAs
```{r first filter, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Me deshago de las secuencias de ASV que no fueron asignadas a nivel de Reino y Supergrupo
unassigned <- TAXA[rowSums(is.na(TAXA[, c(3,4)])) > 0, ]
nada <- TAXA[rowSums(is.na(TAXA[3])) > 0, ]
na.seq <- unassigned[,1]
mTAXA <- TAXA[!(row.names(TAXA) %in% all_of(na.seq)),]
write.csv2(mTAXA, "Filtered_CORE_TAXA.csv")
mCORE <- dplyr::select(CORE, -all_of(na.seq))
write.csv2(mCORE, "Filtered_CORE_ASV_Abundance.csv")

print(all(colnames(mCORE)%in%rownames(mTAXA))) #If TRUE you can continue
```

#Rarefaction (if necessary)
<https://www.nature.com/articles/s41598-021-01636-1>
```{r rarefaction, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
rare.all <- sort(rowSums(mCORE)) #To identify the sample with the smallest number of observations, which will be used as the number of observations to rarefy samples

rrfy <- rarefy(mCORE, rare.all[1]) #rarefaction use the smallest number of observations per sample to extrapolate the expected number if all other samples only had that number of observations
rrfy #Gives an "expected" rarefied number of species (not observations) if only "rare.all[1]" individuals were present per sample

png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_1_rarecurve_mCORE.png", width = 12, height = 6, units = "in", res = 600)
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(0, 0, 0, 0))
rarecurve(x = mCORE, col = "orange", lwd = 2, las = 1, label = TRUE, step = 10, cex = 0.5)
dev.off()

rareCORE <- as.data.frame(rrarefy(mCORE, rrfy[1]))
write.csv2(rareCORE, file = "Rarefacted_filt_CORE_ASV_Abundance.csv")
```

#Dataframes joint
```{r joint, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
PreU <- as.data.frame(t(CORE))
PreU <- mutate(PreU, Seq = all_of(rownames(PreU)), .before = "C1A17")
PreU <- mutate(PreU, 
               Chanaral = rowSums(PreU[2:13]), 
               Flamenco = rowSums(PreU[14:25]), 
               Huasco = rowSums(PreU[26:37]), 
               Pta.Choros = rowSums(PreU[38:42]), 
               Quintero = rowSums(PreU[43:52]), 
               LasCruces = rowSums(PreU[53:64]), 
               Total = rowSums(PreU[2:64])
               )
Pre.ATs <- inner_join(PreU, TAXA, by = "Seq") %>% relocate(ASV, .after = Seq)
rownames(Pre.ATs) <- all_of(Pre.ATs[,1])
write.csv2(Pre.ATs, "Original_Taxonomic_and_Abundance_HCS.csv")

Union <- as.data.frame(t(mCORE))
Union <- mutate(Union, Seq = all_of(rownames(Union)), .before = "C1A17")
Union <- mutate(Union, 
                Chanaral = rowSums(Union[2:13]), 
                Flamenco = rowSums(Union[14:25]), 
                Huasco = rowSums(Union[26:37]), 
                Pta.Choros = rowSums(Union[38:42]), 
                Quintero = rowSums(Union[43:52]), 
                LasCruces = rowSums(Union[53:64]), 
                Total = rowSums(Union[2:64])
                )
ATs <- inner_join(Union, mTAXA, by = "Seq") %>% relocate(ASV, .after = Seq)
rownames(ATs) <- all_of(ATs[,1])
write.csv2(ATs, "Taxonomic_and_Abundance_CORE.csv")
```

#UpSet preparation
```{r upset prep, echo=FALSE,message=FALSE, warning=FALSE, include=FALSE}
pre.asv <- Pre.ATs[,2]
pre.ed <- Pre.ATs[, -c(2,72:80)]
rownames(pre.ed) <- pre.asv
write.csv2(pre.ed, "Original_Edited_Taxonomic_and_Abundance_HCS.csv")
Pre.APATs <- pre.ed[, -1]
Pre.APATs <- vegan::decostand(Pre.APATs, method = "pa")
Pre.APATs <- add_column(Pre.APATs, Seq = all_of(pre.ed$Seq), .before = "C1A17")
write.csv2(Pre.APATs, "Original_Absence_Presence_HCS.csv")

asv <- ATs[,2]
edited <- ATs[, -c(2,72:80)]
rownames(edited) <- asv
write.csv2(edited, "edited_Taxonomic_and_Abundance_CORE.csv")
APATs <- edited[, -1]
APATs <- vegan::decostand(APATs, method = "pa")
APATs <- add_column(APATs, Seq = all_of(edited$Seq), .before = "C1A17")
write.csv2(APATs, "Absence_Presence_CORE.csv")
```

#UpSet
##Complete UpSet
```{r complete, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
pre.ap <- read.csv("Original_Absence_Presence_HCS.csv", 
                   header = TRUE, 
                   sep = ";", 
                   dec = ".", 
                   skip = 0)

aus.pres <- read.csv("Absence_Presence_CORE.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".", 
                     skip = 0)

png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_2_Complete_UpSet.png", width = 50, height = 23, units = "in", res = 600)
upset(aus.pres, 
      nsets = 6, 
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      empty.intersections = "on", 
      keep.order = TRUE, 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 2, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site"
      )
dev.off()
```

##Shorter UpSet
```{r shorter, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_3_Shorter_UpSet.png", width = 40, height = 21, units = "in", res = 600)
upset(aus.pres, 
      nsets = 6,
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      intersections = list("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral", 
                           list("Chanaral", "Flamenco"), 
                           list("Huasco", "Pta.Choros"), 
                           list("Quintero", "LasCruces"), 
                           list("Chanaral", "Huasco"), 
                           list("Chanaral", "Quintero"),
                           list("Huasco", "Quintero"),
                           list("Flamenco", "Pta.Choros"),
                           list("Flamenco", "LasCruces"),
                           list("Pta.Choros", "LasCruces"),
                           list("Quintero", "LasCruces"),
                           list("Chanaral", "Huasco", "Quintero"), 
                           list("Flamenco", "Pta.Choros", "LasCruces"),
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros"),  
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "LasCruces"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces")
                           ),
      empty.intersections = "on", 
      keep.order = TRUE, 
      query.legend = "top", 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 2, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site")
dev.off()
```

##Selected UpSet
```{r selected, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Modify this according to selected intersections from previous UpSet
png("/Documents/GitHub/CORE/Camilo/Analisis/Figuras/Figura_4_shorter_UpSet_color_coded.png", width = 40, height = 17, units = "in", res = 600)
upset(aus.pres, 
      nsets = 6,
      nintersects = NA, 
      sets = c("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral"), 
      intersections = list("LasCruces", "Quintero", "Pta.Choros", "Huasco", "Flamenco", "Chanaral", 
                           list("Chanaral", "Flamenco"), 
                           list("Huasco", "Pta.Choros"), 
                           list("Quintero", "LasCruces"), 
                           list("Chanaral", "Huasco"), 
                           list("Chanaral", "Quintero"),
                           list("Huasco", "Quintero"),
                           list("Flamenco", "Pta.Choros"),
                           list("Flamenco", "LasCruces"),
                           list("Pta.Choros", "LasCruces"),
                           list("Quintero", "LasCruces"),
                           list("Chanaral", "Huasco", "Quintero"), 
                           list("Flamenco", "Pta.Choros", "LasCruces"),
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros"),  
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "LasCruces"), 
                           list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces")
                           ),
      empty.intersections = "on", 
      keep.order = TRUE, 
      query.legend = "top", 
      queries = list(list(query = intersects, params = "Chanaral", color = "#FF8811", active = TRUE, query.name = "Unique Chañaral ASV"), 
                     list(query = intersects, params = "Flamenco", color = "#F4D06F", active = TRUE, query.name = "Unique Flamenco ASV"), 
                     list(query = intersects, params = "Huasco", color = "#392F5A", active = TRUE, query.name = "Unique Huasco ASV"), 
                     list(query = intersects, params = "Pta.Choros", color = "#403286", active = TRUE, query.name = "Unique Punta Choros ASV"), 
                     list(query = intersects, params = "Quintero", color = "#18E0BD", active = TRUE, query.name = "Unique Quintero ASV"), 
                     list(query = intersects, params = "LasCruces", color = "#80EB9F", active = TRUE, query.name = "Unique Las Cruces ASV"), 
                     list(query = intersects, params = list("Chanaral", "Flamenco", "Huasco", "Pta.Choros", "Quintero", "LasCruces"), color = "#EF233C", active = TRUE, query.name = "Total ASV shared")
                     ), 
      point.size = 3.5, 
      line.size = 1.5, 
      text.scale = 3, 
      mainbar.y.label = "Sites Intersections", 
      sets.x.label = "ASV per sampling site")
dev.off()
```

#ASV identification
##Shared
```{r shared, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
pre.sha <- pre.ap %>% dplyr::filter(Chanaral ==1 & Flamenco == 1 & Huasco == 1 & Pta.Choros ==1 & Quintero == 1 & LasCruces == 1)
pre.sha.asv <- dplyr::select(CORE, all_of(pre.sha$Seq))
write.csv2(pre.sha.asv, "Original_Unfiltered_HCS_Shared_ASV_Abundance.csv")
  
shared <- aus.pres %>% dplyr::filter(Chanaral == 1 & Flamenco == 1 & Huasco == 1 & Pta.Choros == 1 & Quintero == 1 & LasCruces == 1)
shared.asv <- dplyr::select(mCORE, all_of(shared$Seq))
write.csv2(shared.asv, "Shared_ASV_abundance.csv")
```

##Uniques
###Chañaral
```{r chañaral, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
pre.cha <- pre.ap %>% dplyr::filter(Chanaral == 1)
pre.cha.asv <- dplyr::select(CORE, all_of(pre.cha$Seq))
pre.cha.asv <- pre.cha.asv[c(1:12),]
write.csv2(as.data.frame(t(pre.cha.asv)), "Original_Unfiltered_Chanaral_HCS_ASV_Abundance.csv")

u.pre.cha <- pre.ap %>% dplyr::filter(Chanaral == 1 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.cha.asv <- dplyr::select(CORE, all_of(u.pre.cha$Seq))
u.pre.cha.asv <- u.pre.cha.asv[c(1:12),]
write.csv2(u.pre.cha.asv, "Original_Unfiltered_Chanaral_Unique_HCS_ASV_Abundance.csv")

chanaral <- aus.pres %>% dplyr::filter(Chanaral == 1 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
cha.asv <- dplyr::select(mCORE, all_of(chanaral$Seq))
write.csv2(cha.asv, "Chanaral_unique_ASV_abundance.csv")
```

###Flamenco
```{r flamenco,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
pre.fla <- pre.ap %>% dplyr::filter(Flamenco == 1)
pre.fla.asv <- dplyr::select(CORE, all_of(pre.fla$Seq))
pre.fla.asv <- pre.fla.asv[c(13:24),]
write.csv2(as.data.frame(t(pre.fla.asv)), "Original_Unfiltered_Flamenco_HCS_ASV_Abundance.csv")

u.pre.fla <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 1 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.fla.asv <- dplyr::select(CORE, all_of(u.pre.fla$Seq))
u.pre.fla.asv <- u.pre.fla.asv[c(13:24),]
write.csv2(u.pre.fla.asv, "Original_Unfiltered_Flamenco_HCS_Unique_ASV_Abundance.csv")

flamenco <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 1 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
fla.asv <- dplyr::select(mCORE, all_of(flamenco$Seq))
write.csv2(fla.asv, "Flamenco_unique_ASV_abundance.csv")
```

###Huasco
```{r Huasco, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
pre.hu <- pre.ap %>% dplyr::filter(Huasco == 1)
pre.hu.asv <- dplyr::select(CORE, all_of(pre.hu$Seq))
pre.hu.asv <- pre.hu.asv[c(25:36),]
write.csv2(as.data.frame(t(pre.hu.asv)), "Original_Unfiltered_Huasco_HCS_ASV_Abundance.csv")

u.pre.hu <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 1 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
u.pre.hu.asv <- dplyr::select(CORE, all_of(u.pre.hu$Seq))
u.pre.hu.asv <- u.pre.hu.asv[c(25:36),]
write.csv2(u.pre.hu.asv, "Original_Unfiltered_Huasco_Unique_HCS_ASV_Abundance.csv")

huasco <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 1 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 0)
hu.asv <- dplyr::select(mCORE, all_of(huasco$Seq))
write.csv2(hu.asv, "Huasco_unique_ASV_abundance.csv")
```

###Punta de Choros
```{r pta. choros, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
pre.pch <- pre.ap %>% dplyr::filter(Pta.Choros == 1)
pre.pch.asv <- dplyr::select(CORE, all_of(pre.pch$Seq))
pre.pch.asv <- pre.pch.asv[c(37:41),]
write.csv2(as.data.frame(t(pre.pch.asv)), "Original_Unfiltered_Punta_Choros_HCS_ASV_Abundance.csv")

u.pre.pch <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 1 & Quintero == 0 & LasCruces == 0)
u.pre.pch.asv <- dplyr::select(CORE, all_of(u.pre.pch$Seq))
u.pre.pch.asv <- u.pre.pch.asv[c(37:41),]
write.csv2(u.pre.pch.asv, "Original_Unfiltered_Punta_Choros_HCS_Unique_ASV_Abundance.csv")

choros <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 1 & Quintero == 0 & LasCruces == 0)
pch.asv <- dplyr::select(mCORE, all_of(choros$Seq))
write.csv2(pch.asv, "Punta_Choros_unique_ASV_abundance.csv")
```

###Quintero
```{r quintero, echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
pre.qin <- pre.ap %>% dplyr::filter(Quintero == 1)
pre.qin.asv <- dplyr::select(CORE, all_of(pre.qin$Seq))
pre.qin.asv <- pre.qin.asv[c(42:51),]
write.csv2(as.data.frame(t(pre.qin.asv)), "Original_Unfiltered_Quintero_HCS_ASV_Abundance.csv")

u.pre.qin <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 1 & LasCruces == 0)
u.pre.qin.asv <- dplyr::select(CORE, all_of(u.pre.qin$Seq))
u.pre.qin.asv <- u.pre.qin.asv[c(42:51),]
write.csv2(u.pre.qin.asv, "Original_Unfiltered_Quintero_HCS_Unique_ASV_Abundance.csv")

quintero <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 1 & LasCruces == 0)
qin.asv <- dplyr::select(mCORE, all_of(quintero$Seq))
write.csv2(qin.asv, "Quintero_unique_ASV_abundance.csv")
```

###Las Cruces
```{r las cruces, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
pre.lc <- pre.ap %>% dplyr::filter(LasCruces == 1)
pre.lc.asv <- dplyr::select(CORE, all_of(pre.lc$Seq))
pre.lc.asv <- pre.lc.asv[c(52:63),]
write.csv2(as.data.frame(t(pre.lc.asv)), "Original_Unfiltered_Las_Cruces_HCS_ASV_Abundance.csv")

u.pre.lc <- pre.ap %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 1)
u.pre.lc.asv <- dplyr::select(CORE, all_of(u.pre.lc$Seq))
u.pre.lc.asv <- u.pre.lc.asv[c(52:63),]
write.csv2(u.pre.lc.asv, "Original_Unfiltered_Las_Cruces_HCS_Unique_ASV_Abundance.csv")

cruces <- aus.pres %>% dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta.Choros == 0 & Quintero == 0 & LasCruces == 1)
lc.asv <- dplyr::select(mCORE, all_of(cruces$Seq))
write.csv2(lc.asv, "Las_Cruces_unique_ASV_abundance.csv")
```

##Others
```{r others, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
others <- dplyr::select(CORE, -all_of(pre.sha$Seq)) %>% 
  dplyr::select(-all_of(u.pre.cha$Seq)) %>% 
  dplyr::select(-all_of(u.pre.fla$Seq)) %>% 
  dplyr::select(-all_of(u.pre.hu$Seq)) %>% 
  dplyr::select(-all_of(u.pre.pch$Seq)) %>% 
  dplyr::select(-all_of(u.pre.qin$Seq)) %>% 
  dplyr::select(-all_of(u.pre.lc$Seq))
write.csv2(others, "Original_Unfiltered_HCS_Others_ASV_Abundance.csv")
inv.others <- as.data.frame(t(others))
write.csv2(inv.others, "Inverted_Original_Unfiltered_HCS_Others_ASV_Abundance.csv")

rest <- dplyr::select(mCORE, -all_of(shared$Seq)) %>% 
  dplyr::select(-all_of(chanaral$Seq)) %>% 
  dplyr::select(-all_of(flamenco$Seq)) %>% 
  dplyr::select(-all_of(huasco$Seq)) %>% 
  dplyr::select(-all_of(choros$Seq)) %>% 
  dplyr::select(-all_of(quintero$Seq)) %>% 
  dplyr::select(-all_of(cruces$Seq))
write.csv2(rest, "rest_ASV_abundance.csv")
crest <- as.data.frame(t(rest))
write.csv2(crest, "inverted_rest_ASV_abundance.csv")
```

##Managing the different ASV abundances
There are 341 shared ASV from unfiltered CORE
First we are going to identify the total abundance of these ASV and their abundance per site
Total Shared ASV Abundance = *2474548*
Chañaral Shared ASV Abundance = *420995*
Flamenco Shared ASV Abundance = *431629*
Huasco Shared ASV Abundance = *571797*
Pta. Choros Shared ASV Abundance = *204389*
Quintero Shared ASV Abundance = *401248*
Las Cruces Shared ASV Abundance = *444490*

Then we are going to get the abundance of the Rest of ASV per site, by extracting Uniques and Shared ASV sequences
```{r rest abundance, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Chañaral
pre.rest.cha <- dplyr::select(pre.cha.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.cha$Seq))
write.csv2(as.data.frame(t(pre.rest.cha)), "Original_Unfiltered_Other_Chanaral_HCS_ASV_Abundance.csv")

#Flamenco
pre.rest.fla <- dplyr::select(pre.fla.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.fla$Seq))
write.csv2(as.data.frame(t(pre.rest.fla)), "Original_Unfiltered_Other_Flamenco_HCS_ASV_Abundance.csv")

#Huasco
pre.rest.hu <- dplyr::select(pre.hu.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.hu$Seq))
write.csv2(as.data.frame(t(pre.rest.hu)), "Original_Unfiltered_Other_Huasco_HCS_ASV_Abundance.csv")

#Pta.Choros
pre.rest.pch <- dplyr::select(pre.pch.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.pch$Seq))
write.csv2(as.data.frame(t(pre.rest.pch)), "Original_Unfiltered_Other_Pta_Choros_HCS_ASV_Abundance.csv")

#Quintero
pre.rest.qin <- dplyr::select(pre.qin.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.qin$Seq))
write.csv2(as.data.frame(t(pre.rest.qin)), "Original_Unfiltered_Other_Quintero_HCS_ASV_Abundance.csv")

#Las Cruces
pre.rest.lc <- dplyr::select(pre.lc.asv, -all_of(pre.sha$Seq)) %>% dplyr::select(-all_of(u.pre.lc$Seq))
write.csv2(as.data.frame(t(pre.rest.lc)), "Original_Unfiltered_Other_Las_Cruces_HCS_ASV_Abundance.csv")
```

